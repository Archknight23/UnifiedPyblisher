<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Publisher - Multi-Platform Social Media Post</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval' qrc:;">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .platform-card {
            transition: all 0.3s ease;
        }

        .platform-card:hover {
            transform: translateY(-2px);
        }

        .platform-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .char-count {
            transition: all 0.2s ease;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
            font-weight: 500;
        }

        .char-count.warning {
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
            background: rgba(251, 191, 36, 0.1);
        }

        .char-count.danger {
            color: #f87171;
            border-color: rgba(248, 113, 113, 0.3);
            background: rgba(248, 113, 113, 0.1);
        }

        .preview-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .toast {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .history-item {
            transition: background-color 0.2s ease;
        }

        .history-item:hover {
            background-color: #f3f4f6;
        }

        /* Queue animations */
        .queue-panel {
            animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .queue-item {
            transition: all 0.3s ease;
        }

        .queue-item.active {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.3);
            }
        }

        .queue-item.completed {
            opacity: 0.6;
        }

        .queue-item.completed .checkmark {
            animation: checkmarkPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmarkPop {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .progress-bar-fill {
            transition: width 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .celebrate {
            animation: celebrate 0.6s ease-out;
        }

        @keyframes celebrate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .queue-button {
            transition: all 0.2s ease;
        }

        .queue-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .queue-button:active:not(:disabled) {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-share-alt text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Chaos Foundry Unified Publishing Service</h1>
                        <p class="text-xs text-gray-400">Chaos Foundry Tech Division Research Project</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openSettings()" class="text-gray-400 hover:text-white transition">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2 text-sm">
                        <span id="connectionStatus" class="status-dot w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-gray-400" id="status">Ready</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Column - Post Editor -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Platform Selection -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-globe text-blue-400"></i>
                        Pick your Poison
                    </h2>
                    <div class="grid grid-cols-3 gap-4">
                        <!-- X/Twitter -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-blue-500/50">
                            <input type="checkbox" id="platform-x" class="hidden platform-toggle" checked onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center">
                                    <i class="fab fa-x-twitter text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">X / Twitter</div>
                                    <div class="text-xs text-gray-400">280 chars</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>

                        <!-- Bluesky -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-blue-400/50">
                            <input type="checkbox" id="platform-bluesky" class="hidden platform-toggle" checked onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-cloud text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">Bluesky</div>
                                    <div class="text-xs text-gray-400">300 chars</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>

                        <!-- YouTube Community -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-red-500/50">
                            <input type="checkbox" id="platform-youtube" class="hidden platform-toggle" onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center">
                                    <i class="fab fa-youtube text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">YouTube</div>
                                    <div class="text-xs text-gray-400">Community</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Post Editor -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-white font-semibold flex items-center gap-2">
                            <i class="fas fa-pen text-green-400"></i>
                            Compose your message
                        </h2>
                        <div class="flex items-center gap-2 text-sm">
                            <button onclick="insertTag('bold')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Bold">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button onclick="insertTag('italic')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Italic">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button onclick="insertTag('link')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <span class="h-6 w-px bg-gray-700 mx-1"></span>
                            <button onclick="document.getElementById('imageInput').click()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Add Image">
                                <i class="fas fa-image"></i>
                            </button>
                            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        </div>
                    </div>

                    <div class="relative">
                        <textarea
                            id="postContent"
                            rows="6"
                            class="w-full bg-gray-900/50 border border-white/10 rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition resize-none"
                            placeholder="What's Happening?"
                            oninput="updateCharCounts()"
                        ></textarea>

                        <!-- Image Preview -->
                        <div id="imagePreview" class="hidden mt-3">
                            <div class="relative inline-block">
                                <img id="previewImg" src="" alt="Preview" class="max-h-32 rounded-lg">
                                <button onclick="removeImage()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Character Counts -->
                    <div class="flex flex-wrap gap-4 mt-4">
                        <div id="charCountX" class="char-count text-sm">
                            <i class="fab fa-x-twitter mr-1"></i>X: <span>0</span>/280
                        </div>
                        <div id="charCountBluesky" class="char-count text-sm">
                            <i class="fas fa-cloud mr-1"></i>Bluesky: <span>0</span>/300
                        </div>
                        <div id="charCountYoutube" class="char-count text-sm">
                            <i class="fab fa-youtube mr-1"></i>YouTube: <span>0</span>/2200
                        </div>
                    </div>

                    <!-- Post Button -->
                    <div class="flex flex-wrap items-center justify-between gap-3 mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-3 text-sm text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="selectedCount">2 platforms selected</span>
                            <button
                                onclick="copyPostContent()"
                                class="px-3 py-1 rounded-lg border border-white/10 text-gray-300 hover:text-white hover:border-white/20 transition"
                                title="Copy the post text"
                            >
                                <i class="fas fa-copy mr-1"></i>Copy Content
                            </button>
                        </div>
                        <button
                            onclick="publishPost()"
                            id="publishBtn"
                            class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-xl flex items-center gap-2 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        >
                            <i class="fas fa-paper-plane"></i>
                            <span>Publish Transmission</span>
                        </button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-eye text-yellow-400"></i>
                        Live Preview
                    </h2>
                    <div id="previewContainer" class="space-y-4">
                        <!-- X Preview -->
                        <div id="previewX" class="bg-black rounded-xl p-4 border border-gray-700">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-gray-700 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewXAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewXAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fab fa-x-twitter text-gray-500"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewXName" class="font-bold text-white">Your Name</span>
                                        <span id="previewXHandle" class="text-gray-500">@handle</span>
                                        <span class="text-gray-600">Â·</span>
                                        <span class="text-gray-500 text-sm">now</span>
                                    </div>
                                    <p id="previewXText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewXImage" class="hidden mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Bluesky Preview -->
                        <div id="previewBluesky" class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 rounded-xl p-4 border border-blue-700/50" style="display:none;">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewBlueskyAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewBlueskyAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fas fa-cloud text-blue-200"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewBlueskyName" class="font-bold text-white">Your Name</span>
                                        <span id="previewBlueskyHandle" class="text-blue-300">@handle.bsky.social</span>
                                    </div>
                                    <p id="previewBlueskyText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewBlueskyImage" class="hidden mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- YouTube Preview -->
                        <div id="previewYoutube" class="bg-gradient-to-br from-red-900/50 to-red-800/30 rounded-xl p-4 border border-red-700/50 hidden">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-red-600 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewYoutubeAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewYoutubeAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fab fa-youtube text-red-200"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewYoutubeName" class="font-bold text-white">Your Channel</span>
                                        <span id="previewYoutubeHandle" class="text-red-300">YouTube</span>
                                    </div>
                                    <p id="previewYoutubeText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewYoutubeImage" class="hidden mt-3"></div>
                                    <div class="flex items-center gap-4 mt-3 text-gray-400 text-sm">
                                        <span><i class="far fa-thumbs-up mr-1"></i>0</span>
                                        <span><i class="far fa-comment mr-1"></i>0</span>
                                        <span><i class="fas fa-share mr-1"></i>Share</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - History & Stats -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt text-blue-400"></i>
                        Quick Actions
                    </h2>
                    <div class="space-y-3 text-sm">
                        <button onclick="openComposer('x')" class="w-full bg-gray-800/50 hover:bg-gray-800 text-white py-2 rounded-lg transition flex items-center justify-between">
                            <span><i class="fab fa-x-twitter mr-2 text-gray-300"></i>Open X Composer</span>
                            <i class="fas fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                        </button>
                        <button onclick="openComposer('youtube')" class="w-full bg-gray-800/50 hover:bg-gray-800 text-white py-2 rounded-lg transition flex items-center justify-between">
                            <span><i class="fab fa-youtube mr-2 text-red-500"></i>Open YouTube Studio</span>
                            <i class="fas fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        Use Copy Content, then paste into the composer.
                    </p>
                </div>
                <!-- Publishing Queue Panel -->
                <div id="queuePanel" class="hidden queue-panel bg-black/30 backdrop-blur-md rounded-2xl border border-white/10 overflow-hidden">
                    <!-- Progress Bar -->
                    <div class="h-1 bg-gray-800">
                        <div id="queueProgressBar" class="progress-bar-fill h-full bg-gradient-to-r from-blue-500 to-purple-600" style="width: 0%"></div>
                    </div>

                    <div class="p-6">
                        <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-tasks text-blue-400"></i>
                            Publishing Queue
                            <span id="queueCount" class="text-xs text-gray-400 ml-auto">0/0</span>
                        </h3>

                        <!-- Queue Items Container -->
                        <div id="queueItems" class="space-y-3 mb-4">
                            <!-- Queue items will be inserted here -->
                        </div>

                        <!-- Action Buttons -->
                        <div id="queueActions" class="space-y-2">
                            <button id="queueActionBtn" onclick="handleQueueAction()" class="queue-button w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-rocket mr-2"></i>
                                <span id="queueActionText">Start</span>
                            </button>
                            <button id="queueDoneBtn" onclick="markCurrentDone()" class="queue-button hidden w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl">
                                <i class="fas fa-check mr-2"></i>
                                Done - Next Platform
                            </button>
                        </div>

                        <!-- Completion Message -->
                        <div id="queueComplete" class="hidden text-center py-4">
                            <div class="text-4xl mb-2">ðŸŽ‰</div>
                            <p class="text-white font-semibold">All platforms posted!</p>
                            <p class="text-xs text-gray-400 mt-1">Great work spreading the word</p>
                        </div>
                    </div>
                </div>
                <!-- Quick Stats -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-purple-400"></i>
                        Today's Stats
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="postsToday" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Posts</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="reactionsToday" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Reactions</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="platformsReached" class="text-2xl font-bold text-white">2</div>
                            <div class="text-xs text-gray-400">Platforms</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="timeSaved" class="text-2xl font-bold text-white">~5m</div>
                            <div class="text-xs text-gray-400">Time Saved</div>
                        </div>
                    </div>
                </div>

                <!-- Post History -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-white font-semibold flex items-center gap-2">
                            <i class="fas fa-history text-orange-400"></i>
                            Recent Posts
                        </h2>
                        <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-white transition">Clear</button>
                    </div>
                    <div id="historyContainer" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">No posts yet</p>
                        </div>
                    </div>
                </div>

                <!-- API Documentation -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-book text-green-400"></i>
                        API Setup
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fab fa-x-twitter text-gray-500 w-5"></i>
                            <span>X: <a href="https://developer.twitter.com" target="_blank" class="text-blue-400 hover:underline">Twitter Dev</a></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fas fa-cloud text-blue-400 w-5"></i>
                            <span>Bluesky: <a href="https://docs.bsky.app" target="_blank" class="text-blue-400 hover:underline">AT Protocol</a></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fab fa-youtube text-red-500 w-5"></i>
                            <span>YouTube: <a href="https://developers.google.com/youtube" target="_blank" class="text-blue-400 hover:underline">Google API</a></span>
                        </div>
                    </div>
                    <button onclick="openApiKeys()" class="w-full mt-4 bg-gray-700/50 hover:bg-gray-700 text-white py-2 rounded-lg transition text-sm">
                        <i class="fas fa-sliders mr-2"></i>Configure Posting
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl w-full max-w-lg border border-white/10 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">Posting Configuration</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <!-- Platform Logins -->
                <div class="bg-gradient-to-r from-gray-800/40 to-gray-900/40 rounded-xl p-4 border border-gray-700">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-right-to-bracket text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">Platform Authentication</span>
                    </div>

                    <!-- How it works explanation -->
                    <div class="bg-gray-800/50 rounded-lg p-3 mb-4 border border-gray-700/50">
                        <p class="text-xs text-gray-300 mb-2">
                            <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                            <span class="font-medium text-white">How Login Works:</span>
                        </p>
                        <ul class="text-xs text-gray-400 space-y-1.5 ml-5 list-disc">
                            <li><span class="text-white font-medium">X/Twitter:</span> Opens popup composer, log in normally. Auto-detects when logged in.</li>
                            <li><span class="text-white font-medium">YouTube:</span> Opens popup composer, log in then <span class="text-yellow-300 font-medium">navigate to any channel page</span> (click your profile icon â†’ "Your channel") to confirm login.</li>
                            <li><span class="text-white font-medium">Bluesky:</span> Uses app password for API access (see below).</li>
                        </ul>
                    </div>

                    <!-- Login Buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openLogin('x')" class="w-full bg-gray-800/70 hover:bg-gray-800 text-white py-2 rounded-lg transition text-sm">
                            <i class="fab fa-x-twitter mr-2 text-gray-300"></i>Login to X
                        </button>
                        <button onclick="openLogin('youtube')" class="w-full bg-gray-800/70 hover:bg-gray-800 text-white py-2 rounded-lg transition text-sm">
                            <i class="fab fa-youtube mr-2 text-red-500"></i>Login to YouTube
                        </button>
                    </div>

                    <!-- Login Status Indicators -->
                    <div class="mt-3 space-y-2 text-xs">
                        <div id="xLoginStatus" class="flex items-center gap-2">
                            <span class="text-gray-400"><i class="fas fa-circle mr-1"></i>X: Not logged in</span>
                        </div>
                        <div id="ytLoginStatus" class="flex items-center gap-2">
                            <span class="text-gray-400"><i class="fas fa-circle mr-1"></i>YouTube: Not logged in</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3">
                        <i class="fas fa-shield-halved text-green-400 mr-1"></i>Sessions persist in isolated browser profiles - you only need to log in once.
                    </p>
                </div>

                <!-- Bluesky Settings -->
                <div class="bg-gradient-to-r from-blue-900/30 to-blue-800/20 rounded-xl p-4 border border-blue-700/30">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-cloud text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">Bluesky</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Handle</label>
                            <input type="text" id="bskyHandle" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="yourname.bsky.social">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">App Password <span class="text-blue-400">(Required)</span></label>
                            <input type="password" id="bskyPassword" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="xxxx-xxxx-xxxx-xxxx">
                        </div>

                        <!-- App Password Instructions -->
                        <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-700/30">
                            <div class="flex items-start gap-2 mb-2">
                                <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-xs text-blue-200 font-medium mb-1">What's an App Password?</p>
                                    <p class="text-xs text-gray-300">Bluesky requires app passwords for third-party apps (not your main password). This keeps your account secure!</p>
                                </div>
                            </div>
                            <div class="text-xs text-gray-300 space-y-1 ml-6">
                                <p><span class="text-blue-300">1.</span> Click the button below to open Bluesky settings</p>
                                <p><span class="text-blue-300">2.</span> Click "Add App Password"</p>
                                <p><span class="text-blue-300">3.</span> Give it a name (e.g., "Chaos Foundry Publisher")</p>
                                <p><span class="text-blue-300">4.</span> <span class="text-yellow-300 font-medium">âš  The password is shown ONCE!</span> Copy it EXACTLY <span class="font-semibold">including all dashes</span> (xxxx-xxxx-xxxx-xxxx), then paste above</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button onclick="openBlueskyAppPasswordSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg transition text-xs font-medium">
                                <i class="fas fa-external-link-alt mr-1"></i>Open App Password Settings
                            </button>
                            <button onclick="testBlueskyConnection()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded-lg transition text-xs font-medium">
                                <i class="fas fa-vial mr-1"></i>Test Connection
                            </button>
                        </div>

                        <!-- Delete Credentials Button -->
                        <button onclick="deleteSavedCredentials()" class="w-full bg-red-900/30 hover:bg-red-900/50 border border-red-700/50 text-red-300 py-2 px-3 rounded-lg transition text-xs font-medium">
                            <i class="fas fa-trash mr-1"></i>Delete Saved Encrypted Credentials
                        </button>

                        <!-- Connection Status -->
                        <div id="bskyConnectionStatus" class="hidden"></div>
                    </div>
                </div>

                <!-- YouTube Settings -->
                <div class="bg-gradient-to-r from-red-900/30 to-red-800/20 rounded-xl p-4 border border-red-700/30">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                            <i class="fab fa-youtube text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">YouTube Community</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Channel Handle</label>
                            <input type="text" id="ytChannelId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-red-500" placeholder="Auto-fills on login">
                        </div>
                        <p class="text-xs text-gray-400">
                            Enter your handle (without @). Opens your community tab for posting.
                        </p>
                    </div>
                </div>

                <!-- X/Twitter Settings -->
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-900/30 rounded-xl p-4 border border-gray-700/60">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">
                            <i class="fab fa-x-twitter text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">X / Twitter</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Username (auto-populated on login)</label>
                            <input type="text" id="xHandle" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500" placeholder="username" readonly>
                        </div>
                        <p class="text-xs text-gray-400">
                            Uses the official intent composer to avoid paid API costs. Username is detected automatically when you log in.
                        </p>
                    </div>
                </div>

                <!-- X/Twitter Settings (removed paid API fields) -->
                <div class="hidden"></div>

                <!-- Legacy fields removed below -->
            </div>
            <div class="p-6 border-t border-white/10 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
                <button onclick="saveApiSettings()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-purple-700 transition">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Post Confirmation Modal -->
    <div id="postConfirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl w-full max-w-2xl border border-white/10 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">âœ“ Post Published Successfully</h3>
                <button onclick="closePostConfirmation()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Post Preview -->
                <div class="bg-gray-800/50 rounded-xl p-4 border border-white/10">
                    <h4 class="text-white font-semibold mb-2">Your Post</h4>
                    <p id="confirmPostContent" class="text-gray-300 whitespace-pre-wrap"></p>
                    <div id="confirmPostImage" class="hidden mt-3"></div>
                </div>

                <!-- Publishing Results -->
                <div class="space-y-3">
                    <h4 class="text-white font-semibold">Publishing Results</h4>
                    <div id="confirmPlatformResults" class="space-y-2">
                        <!-- Platform results will be inserted here -->
                    </div>
                </div>

                <!-- Stats Display (Future: real API stats) -->
                <div class="bg-gradient-to-br from-blue-900/30 to-purple-900/30 rounded-xl p-4 border border-blue-700/30">
                    <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-400"></i>
                        Post Reach
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div id="confirmReach" class="text-2xl font-bold text-white">-</div>
                            <div class="text-xs text-gray-400">Potential Reach</div>
                        </div>
                        <div class="text-center">
                            <div id="confirmPlatforms" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Platforms</div>
                        </div>
                        <div class="text-center">
                            <div id="confirmTimestamp" class="text-sm font-medium text-white">Just now</div>
                            <div class="text-xs text-gray-400">Published</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3 italic">
                        <i class="fas fa-info-circle mr-1"></i>Real-time engagement stats coming soon! Check platform sites for live metrics.
                    </p>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-3">
                    <button onclick="copyPostContent()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition">
                        <i class="fas fa-copy mr-2"></i>Copy Content
                    </button>
                    <button onclick="closePostConfirmation()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg transition">
                        <i class="fas fa-check mr-2"></i>Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // State
        let postHistory = JSON.parse(localStorage.getItem('unifiedPublisherHistory') || '[]');
        let currentImage = null;
        let apiSettings = JSON.parse(localStorage.getItem('unifiedPublisherApiSettings') || '{}');
        const API_CAPABILITIES = {
            bluesky: { enabled: true, label: 'Bluesky' },
            x: { enabled: false, label: 'X/Twitter' },
            youtube: { enabled: false, label: 'YouTube' }
        };
        let pyBridge = null;

        // Queue System State
        let publishQueue = [];
        let currentQueueIndex = -1;
        let queueContent = '';
        let queueImage = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadApiSettings();
            renderHistory();
            updateCharCounts();
            setupCheckboxListeners();
        });

        // Connect to Qt bridge
        if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined') {
            new QWebChannel(qt.webChannelTransport, function (channel) {
                pyBridge = channel.objects.pyBridge;

                // Debug: Log available methods
                if (pyBridge) {
                    console.log('[Bridge] Connected! Available methods:', Object.keys(pyBridge));
                    // Check specific methods
                    console.log('[Bridge] Has openInternalUrl?', typeof pyBridge.openInternalUrl);
                    console.log('[Bridge] Has openExternalUrl?', typeof pyBridge.openExternalUrl);
                }

                if (pyBridge && pyBridge.operationFinished) {
                    pyBridge.operationFinished.connect(function (platform, success, message) {
                        showToast(`${platform}: ${message}`, success ? 'success' : 'error');
                        document.getElementById('status').textContent = `${platform}: ${message}`;
                    });
                }
            });
        }

        // Checkbox styling
        function setupCheckboxListeners() {
            document.querySelectorAll('input.platform-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const indicator = this.parentElement.querySelector('.check-indicator');
                    if (!indicator) return;
                    const checkIcon = indicator.querySelector('i');

                    if (this.checked) {
                        indicator.classList.remove('border-gray-600');
                        indicator.classList.add('border-blue-500', 'bg-blue-500');
                        checkIcon.classList.remove('hidden');
                        this.parentElement.classList.add('ring-2', 'ring-blue-500/30');
                    } else {
                        indicator.classList.add('border-gray-600');
                        indicator.classList.remove('border-blue-500', 'bg-blue-500');
                        checkIcon.classList.add('hidden');
                        this.parentElement.classList.remove('ring-2', 'ring-blue-500/30');
                    }
                });

                // Trigger initial state
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Update character counts
        function updateCharCounts() {
            const content = document.getElementById('postContent').value;
            const len = content.length;

            // X/Twitter
            const xCount = document.querySelector('#charCountX span');
            const xEl = document.getElementById('charCountX');
            xCount.textContent = len;
            xEl.className = 'char-count text-sm';
            if (len > 260) xEl.classList.add('warning');
            if (len > 280) xEl.classList.add('danger');

            // Bluesky
            const bskyCount = document.querySelector('#charCountBluesky span');
            const bskyEl = document.getElementById('charCountBluesky');
            bskyCount.textContent = len;
            bskyEl.className = 'char-count text-sm';
            if (len > 280) bskyEl.classList.add('warning');
            if (len > 300) bskyEl.classList.add('danger');

            // YouTube
            const ytCount = document.querySelector('#charCountYoutube span');
            const ytEl = document.getElementById('charCountYoutube');
            ytCount.textContent = len;
            ytEl.className = 'char-count text-sm';
            if (len > 2000) ytEl.classList.add('warning');
            if (len > 2200) ytEl.classList.add('danger');

            // Update previews
            updatePreviews();

            // Update selected count
            const selectedCount = document.querySelectorAll('input.platform-toggle:checked').length;
            document.getElementById('selectedCount').textContent = `${selectedCount} platform${selectedCount !== 1 ? 's' : ''} selected`;

            // Show/hide preview cards
            document.getElementById('previewX').style.display = document.getElementById('platform-x').checked ? 'block' : 'none';
            document.getElementById('previewBluesky').style.display = document.getElementById('platform-bluesky').checked ? 'block' : 'none';
            document.getElementById('previewYoutube').style.display = document.getElementById('platform-youtube').checked ? 'block' : 'none';
        }

        // Update previews
        function updatePreviews() {
            const content = document.getElementById('postContent').value;
            const escapedContent = escapeHtml(content);

            document.getElementById('previewXText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';
            document.getElementById('previewBlueskyText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';
            document.getElementById('previewYoutubeText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';

            // Image previews
            if (currentImage) {
                document.getElementById('previewXImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewXImage').classList.remove('hidden');
                document.getElementById('previewBlueskyImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewBlueskyImage').classList.remove('hidden');
                document.getElementById('previewYoutubeImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewYoutubeImage').classList.remove('hidden');
            } else {
                document.getElementById('previewXImage').classList.add('hidden');
                document.getElementById('previewBlueskyImage').classList.add('hidden');
                document.getElementById('previewYoutubeImage').classList.add('hidden');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Insert formatting tags
        function insertTag(tag) {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.substring(start, end);

            let replacement = '';
            switch(tag) {
                case 'bold':
                    replacement = `**${selected || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selected || 'italic text'}*`;
                    break;
                case 'link':
                    replacement = `[${selected || 'link text'}](url)`;
                    break;
            }

            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + replacement.length;
            updateCharCounts();
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    document.getElementById('previewImg').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    updatePreviews();
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove image
        function removeImage() {
            currentImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            updatePreviews();
        }

        // Publish post
        async function publishPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                showToast('Please enter some content', 'error');
                return;
            }

            const platforms = [];
            if (document.getElementById('platform-x').checked) platforms.push('x');
            if (document.getElementById('platform-bluesky').checked) platforms.push('bluesky');
            if (document.getElementById('platform-youtube').checked) platforms.push('youtube');

            if (platforms.length === 0) {
                showToast('Please select at least one platform', 'error');
                return;
            }

            // Validate character limits
            const limits = { x: 280, bluesky: 300, youtube: 2200 };
            for (const platform of platforms) {
                if (content.length > limits[platform]) {
                    showToast(`Content exceeds ${platform} character limit`, 'error');
                    return;
                }
            }

            const supportedPlatforms = platforms.filter(platform => API_CAPABILITIES[platform]?.enabled);

            // Disable button
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';

            // Handle API platforms (Bluesky)
            if (supportedPlatforms.length > 0 && pyBridge && pyBridge.handlePublishRequest) {
                const payload = {
                    content: content,
                    platforms: supportedPlatforms,
                    image: currentImage,
                    credentials: apiSettings
                };
                pyBridge.handlePublishRequest(JSON.stringify(payload));
            }

            // Initialize queue for all platforms
            initializeQueue(platforms, content, currentImage);

            // Add to history
            const postRecord = {
                id: Date.now(),
                content,
                image: currentImage,
                platforms,
                results: platforms.map(platform => ({
                    platform,
                    success: API_CAPABILITIES[platform]?.enabled && !!pyBridge,
                    id: Date.now() + Math.random(),
                    skipped: !API_CAPABILITIES[platform]?.enabled
                })),
                timestamp: new Date().toISOString()
            };

            postHistory.unshift(postRecord);
            if (postHistory.length > 50) postHistory.pop();
            localStorage.setItem('unifiedPublisherHistory', JSON.stringify(postHistory));

            // Show post confirmation modal
            showPostConfirmation(postRecord);

            // Reset UI
            document.getElementById('postContent').value = '';
            removeImage();
            renderHistory();
            updateStats();

            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Publish Transmission</span>';
        }

        // Show post confirmation modal
        function showPostConfirmation(postRecord) {
            // Populate content
            document.getElementById('confirmPostContent').textContent = postRecord.content;

            // Show image if present
            const confirmImageEl = document.getElementById('confirmPostImage');
            if (postRecord.image) {
                confirmImageEl.innerHTML = `<img src="${postRecord.image}" class="max-h-48 rounded-lg" alt="Post image">`;
                confirmImageEl.classList.remove('hidden');
            } else {
                confirmImageEl.classList.add('hidden');
            }

            // Show platform results
            const resultsContainer = document.getElementById('confirmPlatformResults');
            resultsContainer.innerHTML = postRecord.results.map(r => {
                let statusHtml = '';
                let statusClass = '';

                if (r.skipped) {
                    statusClass = 'bg-gray-700/50 border-gray-600';
                    statusHtml = '<i class="fas fa-minus-circle text-gray-400 mr-2"></i>Skipped (API not available)';
                } else if (r.success) {
                    statusClass = 'bg-green-900/30 border-green-700/50';
                    statusHtml = '<i class="fas fa-check-circle text-green-400 mr-2"></i>Published successfully';
                } else {
                    statusClass = 'bg-red-900/30 border-red-700/50';
                    statusHtml = '<i class="fas fa-exclamation-circle text-red-400 mr-2"></i>Failed';
                }

                const platformName = API_CAPABILITIES[r.platform]?.label || r.platform.toUpperCase();

                return `
                    <div class="${statusClass} rounded-lg p-3 border flex items-center justify-between">
                        <span class="text-white font-medium">${platformName}</span>
                        <span class="text-sm text-gray-300">${statusHtml}</span>
                    </div>
                `;
            }).join('');

            // Update stats
            const successfulPlatforms = postRecord.results.filter(r => r.success || r.skipped).length;
            document.getElementById('confirmPlatforms').textContent = successfulPlatforms;

            // Format timestamp
            const postTime = new Date(postRecord.timestamp);
            document.getElementById('confirmTimestamp').textContent = postTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // Show modal
            document.getElementById('postConfirmModal').classList.remove('hidden');
        }

        // Close post confirmation modal
        function closePostConfirmation() {
            document.getElementById('postConfirmModal').classList.add('hidden');
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('postConfirmModal');
            if (e.target === modal) {
                closePostConfirmation();
            }
        });

        // Render history
        function renderHistory() {
            const container = document.getElementById('historyContainer');

            if (postHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">No posts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = postHistory.slice(0, 10).map(post => {
                const date = new Date(post.timestamp);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const platformIcons = post.platforms.map(p => {
                    switch(p) {
                        case 'x': return '<i class="fab fa-x-twitter text-gray-400"></i>';
                        case 'bluesky': return '<i class="fas fa-cloud text-blue-400"></i>';
                        case 'youtube': return '<i class="fab fa-youtube text-red-500"></i>';
                        default: return '';
                    }
                }).join(' ');

                const results = post.results.map(r => {
                    if (r.skipped) {
                        return '<i class="fas fa-minus-circle text-gray-400"></i>';
                    }
                    return r.success
                        ? '<i class="fas fa-check-circle text-green-400"></i>'
                        : '<i class="fas fa-exclamation-circle text-red-400"></i>';
                }).join(' ');

                return `
                    <div class="history-item p-3 bg-gray-800/50 rounded-lg cursor-pointer" onclick="viewPost(${post.id})">
                        <div class="flex items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm truncate">${escapeHtml(post.content.substring(0, 50))}${post.content.length > 50 ? '...' : ''}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-gray-500">${timeStr}</span>
                                    <span class="text-xs text-gray-600">&middot;</span>
                                    <span class="text-xs text-gray-500">${platformIcons}</span>
                                    <span class="text-xs text-gray-600">&middot;</span>
                                    <span>${results}</span>
                                </div>
                            </div>
                            ${post.image ? '<i class="fas fa-image text-gray-500 text-xs"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View post details
        function viewPost(id) {
            const post = postHistory.find(p => p.id === id);
            if (!post) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-2xl w-full max-w-md border border-white/10">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h3 class="font-semibold text-white">Post Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="text-sm text-gray-400">${new Date(post.timestamp).toLocaleString()}</div>
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <p class="text-white whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                            ${post.image ? `<img src="${post.image}" class="mt-3 rounded-lg max-h-48" alt="Post image">` : ''}
                        </div>
                        <div>
                            <div class="text-sm text-gray-400 mb-2">Platforms & Status:</div>
                            <div class="flex flex-wrap gap-2">
                                ${post.results.map(r => `
                                    <span class="px-3 py-1 rounded-full text-sm ${r.skipped ? 'bg-gray-500/20 text-gray-300' : r.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                        ${r.platform.toUpperCase()} - ${r.skipped ? 'Skipped' : r.success ? 'Success' : 'Failed'}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Clear history
        function clearHistory() {
            if (confirm('Clear all post history?')) {
                postHistory = [];
                localStorage.setItem('unifiedPublisherHistory', JSON.stringify(postHistory));
                renderHistory();
                updateStats();
            }
        }

        // Update stats
        function updateStats() {
            const today = new Date().toDateString();
            const todayPosts = postHistory.filter(p => new Date(p.timestamp).toDateString() === today);

            document.getElementById('postsToday').textContent = todayPosts.length;
            document.getElementById('reactionsToday').textContent = Math.floor(Math.random() * 50);
            document.getElementById('platformsReached').textContent = new Set(postHistory.flatMap(p => p.platforms)).size;
            document.getElementById('timeSaved').textContent = `~${todayPosts.length * 3}m`;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: 'fa-check',
                error: 'fa-times',
                warning: 'fa-exclamation',
                info: 'fa-info'
            };

            toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg flex items-center gap-2 shadow-lg`;
            toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Queue System Functions
        function initializeQueue(platforms, content, image) {
            publishQueue = platforms.map(platform => ({
                platform,
                status: 'pending', // 'pending', 'active', 'completed'
                label: getPlatformLabel(platform),
                icon: getPlatformIcon(platform),
                color: getPlatformColor(platform),
                isApi: API_CAPABILITIES[platform]?.enabled
            }));
            currentQueueIndex = -1;
            queueContent = content;
            queueImage = image;
            renderQueue();
            showQueuePanel();

            // Auto-start the queue
            setTimeout(() => startQueue(), 300);
        }

        function getPlatformLabel(platform) {
            const labels = { x: 'X / Twitter', bluesky: 'Bluesky', youtube: 'YouTube' };
            return labels[platform] || platform;
        }

        function getPlatformIcon(platform) {
            const icons = {
                x: 'fab fa-x-twitter',
                bluesky: 'fas fa-cloud',
                youtube: 'fab fa-youtube'
            };
            return icons[platform] || 'fas fa-globe';
        }

        function getPlatformColor(platform) {
            const colors = {
                x: 'gray',
                bluesky: 'blue',
                youtube: 'red'
            };
            return colors[platform] || 'gray';
        }

        function showQueuePanel() {
            document.getElementById('queuePanel').classList.remove('hidden');
        }

        function hideQueuePanel() {
            document.getElementById('queuePanel').classList.add('hidden');
        }

        function renderQueue() {
            const container = document.getElementById('queueItems');
            const completedCount = publishQueue.filter(item => item.status === 'completed').length;
            const totalCount = publishQueue.length;
            const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

            // Update progress bar
            document.getElementById('queueProgressBar').style.width = progressPercent + '%';
            document.getElementById('queueCount').textContent = `${completedCount}/${totalCount}`;

            console.log('[Queue] Rendering queue:', publishQueue.map(i => `${i.platform}:${i.status}`).join(', '));

            // Render queue items
            container.innerHTML = publishQueue.map((item, index) => {
                let statusIcon = '';
                let statusText = '';
                let itemClass = 'queue-item';

                if (item.status === 'completed') {
                    statusIcon = '<i class="checkmark fas fa-check-circle text-green-400 text-xl"></i>';
                    statusText = item.isApi ? 'Posted' : 'Done';
                    itemClass += ' completed';
                } else if (item.status === 'active') {
                    statusIcon = '<i class="fas fa-arrow-right text-blue-400 text-xl"></i>';
                    statusText = 'Ready';
                    itemClass += ' active';
                } else {
                    statusIcon = '<i class="fas fa-clock text-gray-600 text-xl"></i>';
                    statusText = 'Waiting';
                }

                return `
                    <div class="${itemClass} bg-gray-800/50 rounded-xl p-4 border border-${item.color}-700/30">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-${item.color}-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="${item.icon} text-white"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-medium">${item.label}</div>
                                <div class="text-xs text-gray-400">
                                    ${statusText} â€¢ ${item.isApi ? 'API' : 'Manual'}
                                </div>
                            </div>
                            ${statusIcon}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleQueueAction() {
            console.log('[Queue] handleQueueAction called, currentQueueIndex:', currentQueueIndex);
            if (currentQueueIndex === -1) {
                // Start the queue
                console.log('[Queue] Starting queue from button click');
                startQueue();
            } else {
                // Process current platform
                console.log('[Queue] Processing current platform from button click');
                processCurrentPlatform();
            }
        }

        function startQueue() {
            console.log('[Queue] Starting queue with', publishQueue.length, 'platforms');

            // Auto-complete API platforms first
            publishQueue.forEach((item, index) => {
                if (item.isApi) {
                    console.log('[Queue] Auto-completing API platform:', item.platform);
                    item.status = 'completed';
                }
            });

            // Find first non-API platform
            currentQueueIndex = publishQueue.findIndex(item => !item.isApi);
            console.log('[Queue] First manual platform index:', currentQueueIndex);

            if (currentQueueIndex === -1) {
                // All platforms are API-based, we're done
                console.log('[Queue] All platforms are API-based, completing immediately');
                completeQueue();
            } else {
                publishQueue[currentQueueIndex].status = 'active';
                console.log('[Queue] Activated platform:', publishQueue[currentQueueIndex].platform);

                // Force button state BEFORE rendering
                document.getElementById('queueActionBtn').classList.remove('hidden');
                document.getElementById('queueDoneBtn').classList.add('hidden');
                document.getElementById('queueActionText').textContent = `Open ${publishQueue[currentQueueIndex].label}`;

                renderQueue();
            }
        }

        function processCurrentPlatform() {
            if (currentQueueIndex < 0 || currentQueueIndex >= publishQueue.length) {
                console.log('[Queue] Invalid queue index:', currentQueueIndex);
                return;
            }

            const current = publishQueue[currentQueueIndex];
            console.log('[Queue] Processing platform:', current.platform);

            if (current.platform === 'youtube') {
                // Copy text to clipboard
                copyTextToClipboard(queueContent);
                showToast('âœ“ Text copied - paste in YouTube Studio', 'success');
            }

            // Open composer
            console.log('[Queue] Opening composer for:', current.platform, 'with content:', queueContent);
            openComposer(current.platform, queueContent);

            // Show "Done" button
            document.getElementById('queueActionBtn').classList.add('hidden');
            document.getElementById('queueDoneBtn').classList.remove('hidden');
        }

        function markCurrentDone() {
            if (currentQueueIndex < 0 || currentQueueIndex >= publishQueue.length) {
                console.log('[Queue] markCurrentDone called with invalid index:', currentQueueIndex);
                return;
            }

            const current = publishQueue[currentQueueIndex];
            console.log('[Queue] Marking platform as done:', current.platform);

            // Mark current as completed
            publishQueue[currentQueueIndex].status = 'completed';

            // Move to next platform
            currentQueueIndex++;
            console.log('[Queue] Moving to next index:', currentQueueIndex);

            // Find next non-completed platform
            while (currentQueueIndex < publishQueue.length && publishQueue[currentQueueIndex].status === 'completed') {
                console.log('[Queue] Skipping already completed platform at index:', currentQueueIndex);
                currentQueueIndex++;
            }

            if (currentQueueIndex >= publishQueue.length) {
                // All done!
                console.log('[Queue] All platforms processed, completing queue');
                completeQueue();
            } else {
                // Activate next platform
                console.log('[Queue] Activating next platform:', publishQueue[currentQueueIndex].platform);
                publishQueue[currentQueueIndex].status = 'active';

                // Force button state for next platform
                document.getElementById('queueActionBtn').classList.remove('hidden');
                document.getElementById('queueDoneBtn').classList.add('hidden');
                document.getElementById('queueActionText').textContent = `Open ${publishQueue[currentQueueIndex].label}`;

                renderQueue();
            }
        }

        function completeQueue() {
            console.log('[Queue] Queue complete! Final statuses:', publishQueue.map(i => `${i.platform}:${i.status}`).join(', '));
            renderQueue();
            document.getElementById('queueActions').classList.add('hidden');
            document.getElementById('queueComplete').classList.remove('hidden');
            document.getElementById('queuePanel').classList.add('celebrate');

            setTimeout(() => {
                document.getElementById('queuePanel').classList.remove('celebrate');
            }, 600);

            // Auto-hide after 10 seconds (increased from 5)
            setTimeout(() => {
                console.log('[Queue] Auto-hiding queue panel');
                resetQueue();
            }, 10000);
        }

        function resetQueue() {
            publishQueue = [];
            currentQueueIndex = -1;
            queueContent = '';
            queueImage = null;
            hideQueuePanel();
            document.getElementById('queueActions').classList.remove('hidden');
            document.getElementById('queueComplete').classList.add('hidden');
            document.getElementById('queueActionBtn').classList.remove('hidden');
            document.getElementById('queueDoneBtn').classList.add('hidden');
        }

        function updateQueueButtons() {
            const current = publishQueue[currentQueueIndex];
            if (!current) return;

            const actionBtn = document.getElementById('queueActionBtn');
            const actionText = document.getElementById('queueActionText');

            actionBtn.classList.remove('hidden');
            document.getElementById('queueDoneBtn').classList.add('hidden');

            actionText.textContent = `Open ${current.label}`;
        }

        function copyTextToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => {
                    fallbackCopyContent(text);
                });
            } else {
                fallbackCopyContent(text);
            }
        }

        function copyPostContent() {
            const content = document.getElementById('postContent').value;
            if (!content) {
                showToast('Nothing to copy yet', 'warning');
                return;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(content)
                    .then(() => showToast('Copied to clipboard', 'success'))
                    .catch(() => fallbackCopyContent(content));
            } else {
                fallbackCopyContent(content);
            }
        }

        function fallbackCopyContent(content) {
            const textarea = document.getElementById('postContent');
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard', 'success');
            } catch (err) {
                showToast('Copy failed. Please select and copy manually.', 'error');
            }
        }

        function openComposer(platform, contentOverride = null) {
            console.log('[Composer] Opening composer for platform:', platform);
            const content = document.getElementById('postContent').value;
            const textToUse = contentOverride !== null ? contentOverride : content;
            console.log('[Composer] Content to use:', textToUse);

            let url = '';
            if (platform === 'x') {
                if (textToUse) {
                    const encoded = encodeURIComponent(textToUse);
                    url = `https://x.com/intent/post?text=${encoded}`;
                } else {
                    url = 'https://x.com/compose/post';
                }
            } else if (platform === 'youtube') {
                const channelHandle = apiSettings.youtube?.channelId;
                url = channelHandle
                    ? `https://www.youtube.com/@${channelHandle}/community`
                    : 'https://www.youtube.com/';
            }

            console.log('[Composer] Generated URL:', url);
            if (!url) {
                console.log('[Composer] No URL generated, aborting');
                return;
            }

            const useInternalComposer = shouldUseInternalComposer(platform);
            console.log('[Composer] Use internal composer:', useInternalComposer);
            console.log('[Composer] pyBridge available:', !!pyBridge);

            if (useInternalComposer && pyBridge && pyBridge.openInternalUrl) {
                console.log('[Composer] Opening in internal browser');
                pyBridge.openInternalUrl(url);
            } else if (pyBridge && pyBridge.openExternalUrl) {
                console.log('[Composer] Opening in external browser');
                pyBridge.openExternalUrl(url);
            } else {
                console.log('[Composer] Fallback: opening in new window');
                window.open(url, '_blank', 'noopener');
            }
        }

        function openLogin(platform) {
            let url = '';
            if (platform === 'x') {
                url = 'https://x.com/login';
            } else if (platform === 'youtube') {
                url = 'https://www.youtube.com/';
            }

            if (!url) return;

            const useInternalComposer = shouldUseInternalComposer(platform);
            if (useInternalComposer && pyBridge && pyBridge.openInternalUrl) {
                pyBridge.openInternalUrl(url);
            } else if (pyBridge && pyBridge.openExternalUrl) {
                pyBridge.openExternalUrl(url);
            } else {
                window.open(url, '_blank', 'noopener');
            }
        }

        // Settings modal
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');

            // Refresh login status indicators when modal opens
            if (apiSettings.x?.handle) {
                updateLoginIndicator('x', true, apiSettings.x.handle);
            } else {
                updateLoginIndicator('x', false, '');
            }
            if (apiSettings.youtube?.channelId) {
                updateLoginIndicator('youtube', true, apiSettings.youtube.channelId);
            } else {
                updateLoginIndicator('youtube', false, '');
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openApiKeys() {
            openSettings();
        }

        // Save API settings
        function saveApiSettings() {
            // Preserve existing avatar data when saving
            const existingBlueskyAvatar = apiSettings.bluesky?.avatar;
            const existingXAvatar = apiSettings.x?.avatar;
            const existingYoutubeAvatar = apiSettings.youtube?.avatar;

            // Get checkbox values if elements exist
            const internalCheckbox = document.getElementById('openComposersInternal');
            const externalYoutubeCheckbox = document.getElementById('forceExternalYoutube');

            apiSettings = {
                bluesky: {
                    handle: document.getElementById('bskyHandle').value,
                    password: document.getElementById('bskyPassword').value,
                    avatar: existingBlueskyAvatar
                },
                youtube: {
                    channelId: document.getElementById('ytChannelId').value,
                    avatar: existingYoutubeAvatar
                },
                x: {
                    handle: apiSettings.x?.handle,
                    avatar: existingXAvatar
                },
                preferences: {
                    openComposersInternal: internalCheckbox ? internalCheckbox.checked : true,
                    forceExternalYoutube: externalYoutubeCheckbox ? externalYoutubeCheckbox.checked : false
                }
            };

            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            updatePreviewIdentity();

            // Show success feedback
            showToast('âœ“ Settings saved successfully!', 'success');

            // Close modal after a short delay so user sees the toast
            setTimeout(() => {
                closeSettings();
            }, 500);
        }

        // Load encrypted credentials on startup
        async function loadEncryptedCredentials() {
            try {
                if (pyBridge && pyBridge.hasSavedCredentials) {
                    const hasCreds = await pyBridge.hasSavedCredentials();
                    if (hasCreds && pyBridge.loadSavedCredentials) {
                        const credsJson = await pyBridge.loadSavedCredentials();
                        if (credsJson) {
                            const creds = JSON.parse(credsJson);
                            console.log('[Credentials] âœ“ Loaded encrypted credentials for:', creds.handle);

                            // Populate settings
                            if (!apiSettings.bluesky) {
                                apiSettings.bluesky = {};
                            }
                            apiSettings.bluesky.handle = creds.handle;
                            apiSettings.bluesky.password = creds.password;

                            // Save to localStorage for session
                            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                            // Update UI
                            document.getElementById('bskyHandle').value = creds.handle;
                            document.getElementById('bskyPassword').value = creds.password;
                            updateBlueskyLoginStatus(creds.handle, '');

                            showToast('ðŸ” Bluesky credentials loaded from secure storage', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('[Credentials] Failed to load encrypted credentials:', error);
            }
        }

        // Load API settings
        function loadApiSettings() {
            if (apiSettings.bluesky?.handle) document.getElementById('bskyHandle').value = apiSettings.bluesky.handle;
            if (apiSettings.bluesky?.password) document.getElementById('bskyPassword').value = apiSettings.bluesky.password;
            if (apiSettings.youtube?.channelId) document.getElementById('ytChannelId').value = apiSettings.youtube.channelId;

            // Load checkbox preferences only if elements exist (removed from UI)
            const internalCheckbox = document.getElementById('openComposersInternal');
            const externalYoutubeCheckbox = document.getElementById('forceExternalYoutube');
            if (internalCheckbox) {
                const internalPreference = apiSettings.preferences?.openComposersInternal;
                internalCheckbox.checked = internalPreference !== false;
            }
            if (externalYoutubeCheckbox) {
                const forceExternalPreference = apiSettings.preferences?.forceExternalYoutube;
                externalYoutubeCheckbox.checked = forceExternalPreference !== false;
            }

            updatePreviewIdentity();

            // Load encrypted credentials after localStorage settings
            loadEncryptedCredentials();
        }

        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });

        // Initialize stats
        updateStats();

        function updatePreviewIdentity() {
            // Update X preview
            const xHandle = (apiSettings.x?.handle || '').trim();
            if (xHandle) {
                const cleanX = xHandle.startsWith('@') ? xHandle.slice(1) : xHandle;
                document.getElementById('previewXName').textContent = cleanX || 'Your Name';
                document.getElementById('previewXHandle').textContent = `@${cleanX}`;

                if (apiSettings.x?.avatar) {
                    const avatarImg = document.getElementById('previewXAvatar');
                    const placeholder = document.getElementById('previewXAvatarPlaceholder');
                    avatarImg.src = apiSettings.x.avatar;
                    avatarImg.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            } else {
                document.getElementById('previewXName').textContent = 'Your Name';
                document.getElementById('previewXHandle').textContent = '@handle';
            }

            // Update Bluesky preview
            const bskyHandle = (apiSettings.bluesky?.handle || '').trim();
            if (bskyHandle) {
                const cleanBsky = bskyHandle.startsWith('@') ? bskyHandle.slice(1) : bskyHandle;
                const displayName = cleanBsky.split('.')[0] || cleanBsky;
                document.getElementById('previewBlueskyName').textContent = displayName || 'Bluesky User';
                document.getElementById('previewBlueskyHandle').textContent = `@${cleanBsky}`;

                if (apiSettings.bluesky?.avatar) {
                    const avatarImg = document.getElementById('previewBlueskyAvatar');
                    const placeholder = document.getElementById('previewBlueskyAvatarPlaceholder');
                    avatarImg.src = apiSettings.bluesky.avatar;
                    avatarImg.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            } else {
                document.getElementById('previewBlueskyName').textContent = 'Your Name';
                document.getElementById('previewBlueskyHandle').textContent = '@handle.bsky.social';
            }

            // Update YouTube preview
            const ytChannelId = (apiSettings.youtube?.channelId || '').trim();
            document.getElementById('previewYoutubeName').textContent = ytChannelId ? 'Your Channel' : 'Your Channel';
            document.getElementById('previewYoutubeHandle').textContent = ytChannelId ? `@${ytChannelId}` : 'YouTube';

            if (apiSettings.youtube?.avatar) {
                const avatarImg = document.getElementById('previewYoutubeAvatar');
                const placeholder = document.getElementById('previewYoutubeAvatarPlaceholder');
                avatarImg.src = apiSettings.youtube.avatar;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        }

        function shouldUseInternalComposer(platform) {
            const preferences = apiSettings.preferences || {};
            const internalEnabled = preferences.openComposersInternal !== false;
            const forceExternalYoutube = preferences.forceExternalYoutube === true;
            if (platform === 'youtube' && forceExternalYoutube) {
                return false;
            }
            return internalEnabled;
        }

        // Bluesky helper functions
        function openBlueskyAppPasswordSettings() {
            const url = 'https://bsky.app/settings/app-passwords';
            if (pyBridge && pyBridge.openInternalUrl) {
                pyBridge.openInternalUrl(url);
            } else {
                window.open(url, '_blank', 'noopener');
            }
        }

        async function deleteSavedCredentials() {
            if (!confirm('Are you sure you want to delete your saved encrypted Bluesky credentials?')) {
                return;
            }

            try {
                if (pyBridge && pyBridge.deleteSavedCredentials) {
                    const result = await pyBridge.deleteSavedCredentials();
                    if (result) {
                        // Clear from localStorage too
                        if (apiSettings.bluesky) {
                            delete apiSettings.bluesky.password;
                        }
                        localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                        // Clear the password field
                        document.getElementById('bskyPassword').value = '';

                        showToast('âœ“ Encrypted credentials deleted', 'success');
                    } else {
                        showToast('Failed to delete credentials', 'error');
                    }
                } else {
                    showToast('Delete function not available', 'error');
                }
            } catch (error) {
                console.error('[Credentials] Delete failed:', error);
                showToast('Error deleting credentials', 'error');
            }
        }

        async function testBlueskyConnection() {
            const handle = document.getElementById('bskyHandle').value.trim();
            const password = document.getElementById('bskyPassword').value.trim();
            const statusEl = document.getElementById('bskyConnectionStatus');

            if (!handle || !password) {
                statusEl.innerHTML = `
                    <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                        <span class="text-xs text-red-300">Please enter both handle and app password</span>
                    </div>
                `;
                statusEl.classList.remove('hidden');
                return;
            }

            // Show loading state
            statusEl.innerHTML = `
                <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-2 flex items-center gap-2">
                    <i class="fas fa-spinner fa-spin text-blue-400"></i>
                    <span class="text-xs text-blue-300">Testing connection...</span>
                </div>
            `;
            statusEl.classList.remove('hidden');

            try {
                // Use the Python bridge to test Bluesky connection
                if (pyBridge && pyBridge.testBlueskyConnection) {
                    const result = await pyBridge.testBlueskyConnection(handle, password);
                    if (result) {
                        statusEl.innerHTML = `
                            <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-2 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span class="text-xs text-green-300">âœ“ Connection successful! Credentials saved.</span>
                            </div>
                        `;
                        // Auto-save on successful test
                        apiSettings.bluesky = { handle, password };
                        localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                        // Update preview with handle (no avatar from app password login)
                        updateBlueskyLoginStatus(handle, '');
                        showToast(`âœ“ Bluesky connected as ${handle}`, 'success');
                    } else {
                        throw new Error('Authentication failed');
                    }
                } else {
                    // Fallback: just save without testing
                    statusEl.innerHTML = `
                        <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-yellow-400"></i>
                            <span class="text-xs text-yellow-300">Saved (test unavailable in this mode)</span>
                        </div>
                    `;
                    apiSettings.bluesky = { handle, password };
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                    // Update preview with handle
                    updateBlueskyLoginStatus(handle, '');
                    showToast(`âœ“ Bluesky credentials saved`, 'success');
                }
            } catch (error) {
                statusEl.innerHTML = `
                    <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-2 flex items-center gap-2">
                        <i class="fas fa-times-circle text-red-400"></i>
                        <span class="text-xs text-red-300">Connection failed. Check your credentials.</span>
                    </div>
                `;
            }

            // Hide status after 5 seconds
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        // Login status update functions (called from ComposerWindow)
        function updateXLoginStatus(username, avatarUrl) {
            console.log('[Login] X login detected:', username, 'Avatar:', avatarUrl);

            // Auto-populate settings
            apiSettings.x = apiSettings.x || {};
            apiSettings.x.handle = username;
            if (avatarUrl) apiSettings.x.avatar = avatarUrl;

            // Update UI field
            const handleInput = document.getElementById('xHandle');
            if (handleInput) {
                handleInput.value = username;
            }

            // Update preview names and avatar
            document.getElementById('previewXName').textContent = username || 'Your Name';
            document.getElementById('previewXHandle').textContent = `@${username}`;

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewXAvatar');
                const placeholder = document.getElementById('previewXAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Show success indicator
            updateLoginIndicator('x', true, username);

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            showToast(`âœ“ Logged in to X as @${username}`, 'success');
        }

        function updateYouTubeLoginStatus(handle, avatarUrl) {
            console.log('[Login] YouTube login detected:', handle, 'Avatar:', avatarUrl);

            // Auto-populate settings
            apiSettings.youtube = apiSettings.youtube || {};
            apiSettings.youtube.channelId = handle;
            if (avatarUrl) apiSettings.youtube.avatar = avatarUrl;

            // Update UI field
            const channelInput = document.getElementById('ytChannelId');
            if (channelInput) {
                channelInput.value = handle;
            }

            // Update preview names and avatar
            document.getElementById('previewYoutubeName').textContent = handle || 'Your Channel';
            document.getElementById('previewYoutubeHandle').textContent = `@${handle}`;

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewYoutubeAvatar');
                const placeholder = document.getElementById('previewYoutubeAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Show success indicator
            updateLoginIndicator('youtube', true, handle);

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            showToast(`âœ“ Logged in to YouTube as @${handle}`, 'success');
        }

        function updateBlueskyLoginStatus(handle, avatarUrl) {
            console.log('[Login] Bluesky login detected:', handle, 'Avatar:', avatarUrl);

            // Auto-populate settings
            apiSettings.bluesky = apiSettings.bluesky || {};
            apiSettings.bluesky.handle = handle;
            if (avatarUrl) apiSettings.bluesky.avatar = avatarUrl;

            // Update UI field
            const handleInput = document.getElementById('bskyHandle');
            if (handleInput) {
                handleInput.value = handle;
            }

            // Update preview names and avatar
            const cleanBsky = handle.startsWith('@') ? handle.slice(1) : handle;
            const displayName = cleanBsky.split('.')[0] || cleanBsky;
            document.getElementById('previewBlueskyName').textContent = displayName || 'Bluesky User';
            document.getElementById('previewBlueskyHandle').textContent = `@${cleanBsky}`;

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewBlueskyAvatar');
                const placeholder = document.getElementById('previewBlueskyAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            showToast(`âœ“ Logged in to Bluesky as ${cleanBsky}`, 'success');
        }

        function updateLoginIndicator(platform, isLoggedIn, username) {
            // Update login status indicators in the settings modal
            const indicators = {
                x: document.getElementById('xLoginStatus'),
                youtube: document.getElementById('ytLoginStatus')
            };

            const platformNames = {
                x: 'X',
                youtube: 'YouTube'
            };

            const indicator = indicators[platform];
            if (indicator) {
                if (isLoggedIn && username) {
                    indicator.innerHTML = `<span class="text-green-400"><i class="fas fa-check-circle mr-1"></i>Logged in as @${username}</span>`;
                } else {
                    indicator.innerHTML = `<span class="text-gray-400"><i class="fas fa-circle mr-1"></i>${platformNames[platform]}: Not logged in</span>`;
                }
            }
        }

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we have saved credentials/sessions
            if (apiSettings.x?.handle) {
                updateLoginIndicator('x', true, apiSettings.x.handle);
            }
            if (apiSettings.youtube?.channelId) {
                updateLoginIndicator('youtube', true, apiSettings.youtube.channelId);
            }
        });
    </script>
</body>
</html>
