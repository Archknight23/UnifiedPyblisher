<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Publisher - Multi-Platform Social Media Post</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval' qrc:;">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Color Palette */
        :root {
            --orange: #f59e0b;
            --purple: #8b5cf6;
            --cyan: #60a5fa;
            --red: #f43f5e;
            --dark: #0b0c10;
            --darker: #050607;
            --glass-white: rgba(255, 255, 255, 0.08);
            --glass-white-hover: rgba(255, 255, 255, 0.12);
            --fg: #e5e7eb;
            --muted: #94a3b8;
            --panel: rgba(255, 255, 255, 0.05);
        }

        /* Glassmorphism scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(10, 10, 10, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--cyan), var(--purple));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 10px rgba(6, 214, 160, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--orange), var(--purple));
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.5);
        }

        /* Animated gradient background */
        body {
            background-color: #0a0808;
            background-image:
                linear-gradient(135deg, rgba(157, 52, 52, 0.08), rgba(91, 31, 94, 0.08)),
                linear-gradient(180deg, rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65));
            color: #e7e5e4;
            min-height: 100vh;
        }

        /* Subtle grid + noise overlay (no animation) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.04) 0px, rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 26px),
                repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.04) 0px, rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 26px);
            opacity: 0.35;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='0.18'/%3E%3C/svg%3E");
            mix-blend-mode: soft-light;
            opacity: 0.18;
            z-index: -1;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Gritty panels */
        .platform-card {
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
            background: rgba(20, 14, 14, 0.75) !important;
            border: 1px solid rgba(255, 255, 255, 0.07) !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .platform-card::before {
            content: none;
        }

        .platform-card:hover {
            background: rgba(34, 19, 19, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.12) !important;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.24);
            transform: translateY(-1px);
        }

        .platform-card.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .char-count {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid rgba(6, 214, 160, 0.3);
            color: var(--cyan);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .char-count.warning {
            color: var(--orange);
            border-color: var(--orange);
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
            background: rgba(255, 140, 66, 0.1);
        }

        .char-count.danger {
            color: var(--red);
            border-color: var(--red);
            box-shadow: 0 4px 12px rgba(239, 71, 111, 0.3);
            background: rgba(239, 71, 111, 0.1);
        }

        .preview-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .tab-active {
            border-bottom: 2px solid var(--purple);
            color: var(--purple);
        }

        .status-dot {
            animation: softPulse 1.6s ease-in-out infinite;
            background-color: #f59e0b;
        }

        @keyframes softPulse {
            0%, 100% {
                opacity: 0.9;
                box-shadow: 0 0 3px rgba(245, 158, 11, 0.7);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 0 2px rgba(245, 158, 11, 0.5);
            }
        }

        .toast {
            animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .history-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 8px;
            padding: 12px;
            border-left: 3px solid transparent;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-left-color: var(--cyan);
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(6, 214, 160, 0.2);
        }

        /* Queue animations */
        .queue-panel {
            animation: slideInRight 0.32s ease;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .queue-item {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .queue-item.active {
            border-color: var(--purple);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        @keyframes glassPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(157, 78, 221, 0.3), 0 4px 16px rgba(0, 0, 0, 0.3);
                background: rgba(157, 78, 221, 0.1);
            }
            50% {
                box-shadow: 0 0 30px rgba(157, 78, 221, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3);
                background: rgba(157, 78, 221, 0.15);
            }
        }

        .queue-item.completed {
            opacity: 0.6;
            border-color: var(--cyan);
            background: rgba(6, 214, 160, 0.05);
        }

        .queue-item.completed .checkmark {
            animation: checkmarkPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmarkPop {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .progress-bar-fill {
            transition: width 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: linear-gradient(90deg, var(--cyan), var(--purple), var(--orange)) !important;
            box-shadow: 0 0 12px rgba(6, 214, 160, 0.5);
        }

        .celebrate {
            animation: celebrate 0.6s ease-out;
        }

        @keyframes celebrate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .queue-button {
            transition: all 0.2s ease;
        }

        .queue-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 0 10px rgba(157, 52, 52, 0.35);
        }

        .queue-button:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Glassmorphism overrides */
        .bg-black\/30 {
            background: rgba(18, 12, 12, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.07) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.22) !important;
        }

        .border-white\/10 {
            border-color: rgba(255, 255, 255, 0.18) !important;
        }

        .text-white {
            color: #e0e0e0 !important;
        }

        .text-gray-400 {
            color: #b0b0b0 !important;
        }

        .text-gray-500 {
            color: #909090 !important;
        }

        .bg-gradient-to-br {
            background: rgba(28, 16, 16, 0.85) !important;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.22);
        }

        .rounded-2xl {
            border-radius: 20px !important;
        }

        .rounded-xl {
            border-radius: 16px !important;
        }

        .rounded-lg {
            border-radius: 12px !important;
        }

        /* Enhanced glassmorphic input styling */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #e0e0e0 !important;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            background: rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3), 0 8px 24px rgba(0, 0, 0, 0.3);
            border-color: var(--purple) !important;
            transform: translateY(-2px);
        }

        /* Enhanced button styling (scoped transitions) */
        button {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            position: relative;
            overflow: hidden;
        }

        button::after {
            content: none;
        }

        button:disabled {
            filter: grayscale(0.5);
            cursor: not-allowed;
        }

        /* Softer header effects */
        h1, h2, h3 {
            transition: color 0.1s ease;
        }

        h1:hover, h2:hover, h3:hover {
            text-shadow: none;
            transform: none;
        }

        /* Improved glass card hover effects */
        .bg-black\/30:hover,
        .bg-gradient-to-br:hover {
            background: rgba(255, 255, 255, 0.07) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.22) !important;
            transform: translateY(-1px);
        }

        /* Loading spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-spinner {
            animation: spin 0.8s linear infinite;
        }

        /* Soft glassmorphic focus rings */
        *:focus-visible {
            outline: 2px solid var(--purple);
            outline-offset: 3px;
            box-shadow: 0 0 0 4px rgba(157, 78, 221, 0.2);
        }

        /* Smooth color transitions */
        * {
            transition: none !important;
        }

        /* Fast accents on controls only */
        button, .platform-card, .queue-item, .grid.grid-cols-2 > div, .char-count, input, select, textarea {
            transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease, background-color 0.1s ease, color 0.1s ease;
        }

        /* Icon soft glow on hover */
        i {
            transition: all 0.3s ease;
        }

        i:hover {
            filter: drop-shadow(0 0 8px currentColor);
            transform: scale(1.1);
        }

        /* Better modal backdrop */
        .fixed.inset-0.bg-black\/70 {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Glassmorphic checkbox styling */
        .check-indicator {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .platform-toggle:checked ~ div .check-indicator {
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            border-color: var(--purple);
            box-shadow: 0 0 8px rgba(157, 78, 221, 0.35);
            transform: scale(1.05);
        }

        .platform-toggle:checked ~ div .check-indicator i {
            display: inline-block !important;
            animation: none;
        }

        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Colorful text selection */
        ::selection {
            background: rgba(157, 78, 221, 0.4);
            color: #ffffff;
        }

        /* Smooth link hover */
        a {
            transition: color 0.12s ease;
            position: relative;
            text-decoration: none;
        }

        a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #9d3410, #5b1f5e);
            transition: width 0.12s ease;
        }

        a:hover::after {
            width: 100%;
        }

        a:hover {
            color: #f59e0b;
        }

        /* Enhanced progress bar */
        .progress-bar-fill {
            transition: width 0.18s ease;
            background: linear-gradient(90deg, #9d3410, #5b1f5e) !important;
            box-shadow: none;
        }

        /* Soft ambient light effect */
        body::before {
            content: none;
        }

        /* Soft header shimmer */
        header {
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: none;
        }

        /* Better placeholder styling */
        ::placeholder {
            color: #666666;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        textarea:focus::placeholder,
        input:focus::placeholder {
            opacity: 0.5;
            transform: translateY(-2px);
        }

        /* Card entrance animation */
        .bg-black\/30,
        .bg-gradient-to-br {
            animation: none;
        }

        /* Publish button */
        #publishBtn {
            background: linear-gradient(135deg, #9d3410, #5b1f5e) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.24);
        }

        #publishBtn:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.28);
        }

        #publishBtn:active {
            transform: translateY(0) scale(0.98);
        }

        /* Enhanced modal entrance */
        .fixed.inset-0 > div {
            animation: none;
        }

        /* Glassmorphic stats card styling */
        .grid.grid-cols-2 > div {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            cursor: default;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .grid.grid-cols-2 > div:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.07);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2), 0 0 0 1px var(--purple);
            border-color: var(--purple);
        }

        /* Improved character counter styling */
        .char-count {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="bg-black min-h-screen" style="background-color: #000000; color: #00ffff;">
    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-black border border-cyan-400 flex items-center justify-center" style="box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);">
                        <i class="fas fa-share-alt" style="color: #00ffff;"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold" style="color: #00ffff; text-transform: uppercase; letter-spacing: 2px;">UNIFIED PUBLISHER</h1>
                        <p class="text-xs" style="color: #888888;">â—† CHAOS FOUNDRY TECH DIVISION â—†</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openSettings()" style="color: #00ffff;" class="hover:text-fuchsia-400 transition">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2 text-sm">
                        <span id="connectionStatus" class="status-dot w-2 h-2 bg-cyan-400 rounded-full"></span>
                        <span id="status" style="color: #888888;">Ready</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Column - Post Editor -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Platform Selection -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                        <i class="fas fa-globe" style="color: #ff00ff;"></i>
                        â–¶ PICK YOUR POISON
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- X/Twitter -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-blue-500/50">
                            <input type="checkbox" id="platform-x" class="hidden platform-toggle" checked onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center">
                                    <i class="fab fa-x-twitter text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">X / Twitter</div>
                                    <div class="text-xs text-gray-400"><span id="xLimitLabel">280</span> chars</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>

                        <!-- Bluesky -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-blue-400/50">
                            <input type="checkbox" id="platform-bluesky" class="hidden platform-toggle" checked onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-cloud text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">Bluesky</div>
                                    <div class="text-xs text-gray-400">300 chars</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>

                        <!-- YouTube Community -->
                        <label class="platform-card cursor-pointer bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl p-4 border border-white/5 hover:border-red-500/50">
                            <input type="checkbox" id="platform-youtube" class="hidden platform-toggle" onchange="updateCharCounts()">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center">
                                    <i class="fab fa-youtube text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">YouTube</div>
                                    <div class="text-xs text-gray-400">Community</div>
                                </div>
                                <div class="check-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs hidden"></i>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Post Editor -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                            <i class="fas fa-pen" style="color: #00ffff;"></i>
                            â–¶ COMPOSE MESSAGE
                        </h2>
                        <div class="flex items-center gap-2 text-sm">
                            <button onclick="insertTag('bold')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Bold">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button onclick="insertTag('italic')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Italic">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button onclick="insertTag('link')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <span class="h-6 w-px bg-gray-700 mx-1"></span>
                            <button onclick="document.getElementById('imageInput').click()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="Add Image">
                                <i class="fas fa-image"></i>
                            </button>
                            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        </div>
                    </div>

                    <div class="relative">
                        <textarea
                            id="postContent"
                            rows="6"
                            class="w-full bg-gray-900/50 border border-white/10 rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition resize-none"
                            placeholder="What's Happening?"
                            oninput="updateCharCounts()"
                        ></textarea>

                        <!-- Image Preview -->
                        <div id="imagePreview" class="hidden mt-3">
                            <div class="relative inline-block">
                                <img id="previewImg" src="" alt="Preview" class="max-h-32 rounded-lg">
                                <button onclick="removeImage()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Character Counts -->
                    <div class="flex flex-wrap gap-4 mt-4">
                        <div id="charCountX" class="char-count text-sm">
                            <i class="fab fa-x-twitter mr-1"></i>X: <span>0</span>/<span id="xLimitCount">280</span>
                        </div>
                        <div id="charCountBluesky" class="char-count text-sm">
                            <i class="fas fa-cloud mr-1"></i>Bluesky: <span>0</span>/300
                        </div>
                        <div id="charCountYoutube" class="char-count text-sm">
                            <i class="fab fa-youtube mr-1"></i>YouTube: <span>0</span>/2200
                        </div>
                    </div>

                    <!-- Post Button -->
                    <div class="flex flex-wrap items-center justify-between gap-3 mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-3 text-sm text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="selectedCount">2 platforms selected</span>
                            <button
                                onclick="copyPostContent()"
                                class="px-3 py-1 rounded-lg border border-white/10 text-gray-300 hover:text-white hover:border-white/20 transition"
                                title="Copy the post text"
                            >
                                <i class="fas fa-copy mr-1"></i>Copy Content
                            </button>
                        </div>
                        <button
                            onclick="publishPost()"
                            id="publishBtn"
                            class="font-semibold py-3 px-8 rounded-xl flex items-center gap-2 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                            style="background: linear-gradient(90deg, #00ffff, #ff00ff); color: #000; border: 2px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);"
                        >
                            <i class="fas fa-paper-plane"></i>
                            <span>PUBLISH TRANSMISSION</span>
                        </button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                        <i class="fas fa-eye" style="color: #ff00ff;"></i>
                        â–¶ LIVE PREVIEW
                    </h2>
                    <div id="previewContainer" class="space-y-4">
                        <!-- X Preview -->
                        <div id="previewX" class="bg-black rounded-xl p-4 border border-gray-700">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-gray-700 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewXAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewXAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fab fa-x-twitter text-gray-500"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewXName" class="font-bold text-white">Your Name</span>
                                        <span id="previewXHandle" class="text-gray-500">@handle</span>
                                        <span class="text-gray-600">Â·</span>
                                        <span class="text-gray-500 text-sm">now</span>
                                    </div>
                                    <p id="previewXText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewXImage" class="hidden mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Bluesky Preview -->
                        <div id="previewBluesky" class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 rounded-xl p-4 border border-blue-700/50" style="display:none;">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewBlueskyAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewBlueskyAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fas fa-cloud text-blue-200"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewBlueskyName" class="font-bold text-white">Your Name</span>
                                        <span id="previewBlueskyHandle" class="text-blue-300">@handle.bsky.social</span>
                                    </div>
                                    <p id="previewBlueskyText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewBlueskyImage" class="hidden mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- YouTube Preview -->
                        <div id="previewYoutube" class="bg-gradient-to-br from-red-900/50 to-red-800/30 rounded-xl p-4 border border-red-700/50 hidden">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-red-600 rounded-full flex-shrink-0 overflow-hidden">
                                    <img id="previewYoutubeAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                                    <div id="previewYoutubeAvatarPlaceholder" class="w-full h-full flex items-center justify-center">
                                        <i class="fab fa-youtube text-red-200"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span id="previewYoutubeName" class="font-bold text-white">Your Channel</span>
                                        <span id="previewYoutubeHandle" class="text-red-300">YouTube</span>
                                    </div>
                                    <p id="previewYoutubeText" class="text-white mt-1 whitespace-pre-wrap"></p>
                                    <div id="previewYoutubeImage" class="hidden mt-3"></div>
                                    <div class="flex items-center gap-4 mt-3 text-gray-400 text-sm">
                                        <span><i class="far fa-thumbs-up mr-1"></i>0</span>
                                        <span><i class="far fa-comment mr-1"></i>0</span>
                                        <span><i class="fas fa-share mr-1"></i>Share</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - History & Stats -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                        <i class="fas fa-bolt" style="color: #ff00ff;"></i>
                        â–¶ QUICK ACTIONS
                    </h2>
                    <div class="space-y-3 text-sm">
                        <button onclick="openComposer('x')" class="w-full bg-gray-800/50 hover:bg-gray-800 text-white py-2 rounded-lg transition flex items-center justify-between">
                            <span><i class="fab fa-x-twitter mr-2 text-gray-300"></i>Open X Composer</span>
                            <i class="fas fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                        </button>
                        <button onclick="openComposer('youtube')" class="w-full bg-gray-800/50 hover:bg-gray-800 text-white py-2 rounded-lg transition flex items-center justify-between">
                            <span><i class="fab fa-youtube mr-2 text-red-500"></i>Open YouTube Studio</span>
                            <i class="fas fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        Use Copy Content, then paste into the composer.
                    </p>
                </div>
                <!-- Publishing Queue Panel -->
                <div id="queuePanel" class="hidden queue-panel bg-black/30 backdrop-blur-md rounded-2xl border border-white/10 overflow-hidden">
                    <!-- Progress Bar -->
                    <div class="h-1 bg-gray-800">
                        <div id="queueProgressBar" class="progress-bar-fill h-full bg-gradient-to-r from-cyan-500 to-fuchsia-600" style="width: 0%"></div>
                    </div>

                    <div class="p-6">
                        <h3 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                            <i class="fas fa-tasks" style="color: #ff00ff;"></i>
                            â–¶ PUBLISHING QUEUE
                            <span id="queueCount" class="text-xs ml-auto" style="color: #888888;">0/0</span>
                        </h3>

                        <!-- Queue Items Container -->
                        <div id="queueItems" class="space-y-3 mb-4">
                            <!-- Queue items will be inserted here -->
                        </div>

                        <!-- Action Buttons -->
                        <div id="queueActions" class="space-y-2">
                            <button id="queueActionBtn" onclick="handleQueueAction()" class="queue-button w-full font-semibold py-3 px-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed" style="background: linear-gradient(90deg, #00ffff, #ff00ff); color: #000; border: 2px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);">
                                <i class="fas fa-rocket mr-2"></i>
                                <span id="queueActionText">START</span>
                            </button>
                            <button id="queueDoneBtn" onclick="markCurrentDone()" class="queue-button hidden w-full font-semibold py-2 px-4 rounded-xl" style="background: linear-gradient(90deg, #00ff00, #00ffff); color: #000; border: 2px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);">
                                <i class="fas fa-check mr-2"></i>
                                DONE - NEXT PLATFORM
                            </button>
                        </div>

                        <!-- Completion Message -->
                        <div id="queueComplete" class="hidden text-center py-4">
                            <div class="text-4xl mb-2">ðŸŽ‰</div>
                            <p class="text-white font-semibold">All platforms posted!</p>
                            <p class="text-xs text-gray-400 mt-1">Great work spreading the word</p>
                        </div>
                    </div>
                </div>
                <!-- Quick Stats -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                        <i class="fas fa-chart-bar" style="color: #ff00ff;"></i>
                        â–¶ TODAY'S STATS
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="postsToday" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Posts</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="reactionsToday" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Reactions</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="platformsReached" class="text-2xl font-bold text-white">2</div>
                            <div class="text-xs text-gray-400">Platforms</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                            <div id="timeSaved" class="text-2xl font-bold text-white">~5m</div>
                            <div class="text-xs text-gray-400">Time Saved</div>
                        </div>
                    </div>
                </div>

                <!-- Post History -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                            <i class="fas fa-history" style="color: #ff00ff;"></i>
                            â–¶ RECENT POSTS
                        </h2>
                        <button onclick="clearHistory()" class="text-xs hover:text-fuchsia-400 transition" style="color: #888888;">Clear</button>
                    </div>
                    <div id="historyContainer" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">No posts yet</p>
                        </div>
                    </div>
                </div>

                <!-- API Documentation -->
                <div class="bg-black/30 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                    <h2 class="font-semibold mb-4 flex items-center gap-2" style="color: #00ffff; text-transform: uppercase;">
                        <i class="fas fa-book" style="color: #ff00ff;"></i>
                        â–¶ API SETUP
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fab fa-x-twitter text-gray-500 w-5"></i>
                            <span>X: <a href="https://developer.twitter.com" target="_blank" class="text-blue-400 hover:underline">Twitter Dev</a></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fas fa-cloud text-blue-400 w-5"></i>
                            <span>Bluesky: <a href="https://docs.bsky.app" target="_blank" class="text-blue-400 hover:underline">AT Protocol</a></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-300">
                            <i class="fab fa-youtube text-red-500 w-5"></i>
                            <span>YouTube: <a href="https://developers.google.com/youtube" target="_blank" class="text-blue-400 hover:underline">Google API</a></span>
                        </div>
                    </div>
                    <button onclick="openApiKeys()" class="w-full mt-4 bg-gray-700/50 hover:bg-gray-700 text-white py-2 rounded-lg transition text-sm">
                        <i class="fas fa-sliders mr-2"></i>Configure Posting
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl w-full max-w-lg border border-white/10 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">Posting Configuration</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <!-- Platform Logins -->
                <div class="bg-gradient-to-r from-gray-800/40 to-gray-900/40 rounded-xl p-4 border border-gray-700">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-right-to-bracket text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">Platform Authentication</span>
                    </div>

                    <!-- How it works explanation -->
                    <div class="bg-gray-800/50 rounded-lg p-3 mb-4 border border-gray-700/50">
                        <p class="text-xs text-gray-300 mb-2">
                            <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                            <span class="font-medium text-white">How Login Works:</span>
                        </p>
                        <ul class="text-xs text-gray-400 space-y-1.5 ml-5 list-disc">
                            <li><span class="text-white font-medium">X/Twitter:</span> Opens popup composer, log in normally. Auto-detects when logged in.</li>
                            <li><span class="text-white font-medium">YouTube:</span> Opens popup composer, log in then <span class="text-yellow-300 font-medium">navigate to any channel page</span> (click your profile icon â†’ "Your channel") to confirm login.</li>
                            <li><span class="text-white font-medium">Bluesky:</span> Uses app password for API access (see below).</li>
                        </ul>
                    </div>

                    <!-- Login Buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openLogin('x')" class="w-full bg-gray-800/70 hover:bg-gray-800 text-white py-2 rounded-lg transition text-sm">
                            <i class="fab fa-x-twitter mr-2 text-gray-300"></i>Login to X
                        </button>
                        <button onclick="openLogin('youtube')" class="w-full bg-gray-800/70 hover:bg-gray-800 text-white py-2 rounded-lg transition text-sm">
                            <i class="fab fa-youtube mr-2 text-red-500"></i>Login to YouTube
                        </button>
                    </div>

                     <!-- Login Status Indicators -->
                     <div class="mt-3 space-y-2 text-xs">
                         <div id="xLoginStatus" class="flex items-center gap-2">
                             <span class="text-gray-400"><i class="fas fa-globe mr-1"></i>X: Uses browser login</span>
                         </div>
                         <div id="ytLoginStatus" class="flex items-center gap-2">
                             <span class="text-gray-400"><i class="fas fa-globe mr-1"></i>YouTube: Uses browser login</span>
                         </div>
                     </div>
                     <p class="text-xs text-gray-400 mt-3">
                         <i class="fas fa-external-link-alt text-blue-400 mr-1"></i>X & YouTube use your system browser. Stay logged in there.
                     </p>
                </div>

                <!-- Bluesky Settings -->
                <div class="bg-gradient-to-r from-blue-900/30 to-blue-800/20 rounded-xl p-4 border border-blue-700/30">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-cloud text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">Bluesky</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Handle</label>
                            <input type="text" id="bskyHandle" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="yourname.bsky.social">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">App Password <span class="text-blue-400">(Required)</span></label>
                            <input type="password" id="bskyPassword" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="xxxx-xxxx-xxxx-xxxx">
                        </div>

                        <!-- App Password Instructions -->
                        <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-700/30">
                            <div class="flex items-start gap-2 mb-2">
                                <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-xs text-blue-200 font-medium mb-1">What's an App Password?</p>
                                    <p class="text-xs text-gray-300">Bluesky requires app passwords for third-party apps (not your main password). This keeps your account secure!</p>
                                </div>
                            </div>
                            <div class="text-xs text-gray-300 space-y-1 ml-6">
                                <p><span class="text-blue-300">1.</span> Click the button below to open Bluesky settings</p>
                                <p><span class="text-blue-300">2.</span> Click "Add App Password"</p>
                                <p><span class="text-blue-300">3.</span> Give it a name (e.g., "Chaos Foundry Publisher")</p>
                                <p><span class="text-blue-300">4.</span> <span class="text-yellow-300 font-medium">âš  The password is shown ONCE!</span> Copy it EXACTLY <span class="font-semibold">including all dashes</span> (xxxx-xxxx-xxxx-xxxx), then paste above</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button onclick="openBlueskyAppPasswordSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg transition text-xs font-medium">
                                <i class="fas fa-external-link-alt mr-1"></i>Open App Password Settings
                            </button>
                            <button onclick="testBlueskyConnection()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded-lg transition text-xs font-medium">
                                <i class="fas fa-vial mr-1"></i>Test Connection
                            </button>
                        </div>

                        <!-- Delete Credentials Button -->
                        <button onclick="deleteSavedCredentials()" class="w-full bg-red-900/30 hover:bg-red-900/50 border border-red-700/50 text-red-300 py-2 px-3 rounded-lg transition text-xs font-medium">
                            <i class="fas fa-trash mr-1"></i>Delete Saved Encrypted Credentials
                        </button>

                        <!-- Connection Status -->
                        <div id="bskyConnectionStatus" class="hidden"></div>
                    </div>
                </div>

                <!-- YouTube Settings -->
                <div class="bg-gradient-to-r from-red-900/30 to-red-800/20 rounded-xl p-4 border border-red-700/30">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                            <i class="fab fa-youtube text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">YouTube Community</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Channel Handle</label>
                            <input type="text" id="ytChannelId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-red-500" placeholder="Auto-fills on login">
                        </div>
                        <p class="text-xs text-gray-400">
                            Enter your handle (without @). Opens your community tab for posting.
                        </p>
                    </div>
                </div>

                <!-- X/Twitter Settings -->
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-900/30 rounded-xl p-4 border border-gray-700/60">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">
                            <i class="fab fa-x-twitter text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">X / Twitter</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Username (auto-populated on login)</label>
                            <input type="text" id="xHandle" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500" placeholder="username" readonly>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Character limit</label>
                            <select id="xCharLimitMode" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500" onchange="handleXCharLimitModeChange()">
                                <option value="standard">Standard (280)</option>
                                <option value="premium">X Premium (25000)</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="number" id="xCharLimitCustom" class="mt-2 hidden w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500" min="1" max="100000" placeholder="Enter custom limit">
                        </div>
                        <p class="text-xs text-gray-400">
                            Uses the official intent composer to avoid paid API costs. Username is detected automatically when you log in.
                        </p>
                    </div>
                </div>

                <!-- Rendering Settings -->
                <div class="bg-gradient-to-r from-slate-800/30 to-slate-900/30 rounded-xl p-4 border border-slate-700/60">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-display text-white text-sm"></i>
                        </div>
                        <span class="font-medium text-white">Renderer</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">QtWebEngine backend</label>
                            <select id="rendererMode" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-slate-500">
                                <option value="auto">Auto (system default)</option>
                                <option value="vulkan">Vulkan</option>
                                <option value="angle">ANGLE (GL)</option>
                                <option value="swiftshader">SwiftShader (software)</option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-400">
                            Renderer changes apply on next launch.
                        </p>
                    </div>
                </div>

                <!-- X/Twitter Settings (removed paid API fields) -->
                <div class="hidden"></div>

                <!-- Legacy fields removed below -->
            </div>
            <div class="p-6 border-t border-white/10 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
                <button onclick="saveApiSettings()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-purple-700 transition">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Post Confirmation Modal -->
    <div id="postConfirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl w-full max-w-2xl border border-white/10 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">âœ“ Post Published Successfully</h3>
                <button onclick="closePostConfirmation()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Post Preview -->
                <div class="bg-gray-800/50 rounded-xl p-4 border border-white/10">
                    <h4 class="text-white font-semibold mb-2">Your Post</h4>
                    <p id="confirmPostContent" class="text-gray-300 whitespace-pre-wrap"></p>
                    <div id="confirmPostImage" class="hidden mt-3"></div>
                </div>

                <!-- Publishing Results -->
                <div class="space-y-3">
                    <h4 class="text-white font-semibold">Publishing Results</h4>
                    <div id="confirmPlatformResults" class="space-y-2">
                        <!-- Platform results will be inserted here -->
                    </div>
                </div>

                <!-- Stats Display (Future: real API stats) -->
                <div class="bg-gradient-to-br from-blue-900/30 to-purple-900/30 rounded-xl p-4 border border-blue-700/30">
                    <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-400"></i>
                        Post Reach
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div id="confirmReach" class="text-2xl font-bold text-white">-</div>
                            <div class="text-xs text-gray-400">Potential Reach</div>
                        </div>
                        <div class="text-center">
                            <div id="confirmPlatforms" class="text-2xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Platforms</div>
                        </div>
                        <div class="text-center">
                            <div id="confirmTimestamp" class="text-sm font-medium text-white">Just now</div>
                            <div class="text-xs text-gray-400">Published</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3 italic">
                        <i class="fas fa-info-circle mr-1"></i>Real-time engagement stats coming soon! Check platform sites for live metrics.
                    </p>
                </div>

                <!-- Quick Actions -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="copyPostContent()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition">
                        <i class="fas fa-copy mr-2"></i>Copy Content
                    </button>
                    <button onclick="closePostConfirmation()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg transition">
                        <i class="fas fa-check mr-2"></i>Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // State
        let postHistory = JSON.parse(localStorage.getItem('unifiedPublisherHistory') || '[]');
        let currentImage = null;
        let apiSettings = JSON.parse(localStorage.getItem('unifiedPublisherApiSettings') || '{}');
        const API_CAPABILITIES = {
            bluesky: { enabled: true, label: 'Bluesky' },
            x: { enabled: false, label: 'X/Twitter' },
            youtube: { enabled: false, label: 'YouTube' }
        };
        const PLATFORM_LIMITS = { bluesky: 300, youtube: 2200 };
        const X_LIMITS = { standard: 280, premium: 25000 };
        let pyBridge = null;

        // Queue System State
        let publishQueue = [];
        let currentQueueIndex = -1;
        let queueContentByPlatform = {};
        let queueImage = null;
        let queueStarted = false;
        let pendingApiPayload = null;
        let pendingApiPlatforms = [];
        let apiPostingInProgress = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadApiSettings();
            renderHistory();
            updateCharCounts();
            setupCheckboxListeners();
        });

        // Connect to Qt bridge
        if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined') {
            new QWebChannel(qt.webChannelTransport, function (channel) {
                pyBridge = channel.objects.pyBridge;

                // Debug: Log available methods
                if (pyBridge) {
                    console.log('[Bridge] Connected! Available methods:', Object.keys(pyBridge));
                    // Check specific methods
                    console.log('[Bridge] Has openInternalUrl?', typeof pyBridge.openInternalUrl);
                    console.log('[Bridge] Has openExternalUrl?', typeof pyBridge.openExternalUrl);
                }

                if (pyBridge && pyBridge.operationFinished) {
                    pyBridge.operationFinished.connect(function (platform, success, message) {
                        showToast(`${platform}: ${message}`, success ? 'success' : 'error');
                        document.getElementById('status').textContent = `${platform}: ${message}`;
                        handlePlatformAutoComplete(platform, success);
                    });
                }

                if (pyBridge) {
                    loadPlatformProfilesFromBridge();
                    syncRendererModeFromBridge();
                }
            });
        }

        // Checkbox styling
        function setupCheckboxListeners() {
            document.querySelectorAll('input.platform-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const indicator = this.parentElement.querySelector('.check-indicator');
                    if (!indicator) return;
                    const checkIcon = indicator.querySelector('i');

                    if (this.checked) {
                        indicator.classList.remove('border-gray-600');
                        indicator.classList.add('border-blue-500', 'bg-blue-500');
                        checkIcon.classList.remove('hidden');
                        this.parentElement.classList.add('ring-2', 'ring-blue-500/30');
                    } else {
                        indicator.classList.add('border-gray-600');
                        indicator.classList.remove('border-blue-500', 'bg-blue-500');
                        checkIcon.classList.add('hidden');
                        this.parentElement.classList.remove('ring-2', 'ring-blue-500/30');
                    }
                });

                // Trigger initial state
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        function getXCharLimit() {
            const xSettings = apiSettings.x || {};
            const mode = xSettings.limitMode || 'standard';
            if (mode === 'custom') {
                const customLimit = Number(xSettings.customLimit);
                if (Number.isFinite(customLimit) && customLimit > 0) {
                    return Math.floor(customLimit);
                }
            }
            if (mode === 'premium') return X_LIMITS.premium;
            return X_LIMITS.standard;
        }

        function getPlatformLimit(platform) {
            if (platform === 'x') return getXCharLimit();
            return PLATFORM_LIMITS[platform] || null;
        }

        function getWarningThreshold(platform, limit) {
            if (!limit) return 0;
            if (platform === 'youtube') return Math.max(0, limit - 200);
            return Math.max(0, limit - 20);
        }

        function getPlatformContent(platform, content) {
            if (!content) return '';
            const limit = getPlatformLimit(platform);
            if (!limit) return content;
            if (content.length <= limit) return content;
            return content.slice(0, limit);
        }

        function refreshXLimitUI() {
            const limit = getXCharLimit();
            const labelEl = document.getElementById('xLimitLabel');
            if (labelEl) labelEl.textContent = limit;
            const countEl = document.getElementById('xLimitCount');
            if (countEl) countEl.textContent = limit;
        }

        function buildPlatformContentMap(content, platforms) {
            const map = {};
            const overLimit = [];
            platforms.forEach(platform => {
                const limit = getPlatformLimit(platform);
                const trimmed = getPlatformContent(platform, content);
                map[platform] = trimmed;
                if (limit && content.length > limit) {
                    overLimit.push({ platform, limit });
                }
            });
            return { map, overLimit };
        }

        // Update character counts
        function updateCharCounts() {
            const content = document.getElementById('postContent').value;
            const len = content.length;
            refreshXLimitUI();

            // X/Twitter
            const xCount = document.querySelector('#charCountX span');
            const xEl = document.getElementById('charCountX');
            const xLimit = getPlatformLimit('x');
            const xWarn = getWarningThreshold('x', xLimit);
            xCount.textContent = len;
            xEl.className = 'char-count text-sm';
            if (len > xWarn) xEl.classList.add('warning');
            if (xLimit && len > xLimit) xEl.classList.add('danger');
            xEl.title = xLimit && len > xLimit ? `Will post first ${xLimit} characters on X` : '';

            // Bluesky
            const bskyCount = document.querySelector('#charCountBluesky span');
            const bskyEl = document.getElementById('charCountBluesky');
            const bskyLimit = getPlatformLimit('bluesky');
            const bskyWarn = getWarningThreshold('bluesky', bskyLimit);
            bskyCount.textContent = len;
            bskyEl.className = 'char-count text-sm';
            if (len > bskyWarn) bskyEl.classList.add('warning');
            if (bskyLimit && len > bskyLimit) bskyEl.classList.add('danger');
            bskyEl.title = bskyLimit && len > bskyLimit ? `Will post first ${bskyLimit} characters on Bluesky` : '';

            // YouTube
            const ytCount = document.querySelector('#charCountYoutube span');
            const ytEl = document.getElementById('charCountYoutube');
            const ytLimit = getPlatformLimit('youtube');
            const ytWarn = getWarningThreshold('youtube', ytLimit);
            ytCount.textContent = len;
            ytEl.className = 'char-count text-sm';
            if (len > ytWarn) ytEl.classList.add('warning');
            if (ytLimit && len > ytLimit) ytEl.classList.add('danger');
            ytEl.title = ytLimit && len > ytLimit ? `Will post first ${ytLimit} characters on YouTube` : '';

            // Update previews
            updatePreviews();

            // Update selected count
            const selectedCount = document.querySelectorAll('input.platform-toggle:checked').length;
            document.getElementById('selectedCount').textContent = `${selectedCount} platform${selectedCount !== 1 ? 's' : ''} selected`;

            // Show/hide preview cards
            document.getElementById('previewX').style.display = document.getElementById('platform-x').checked ? 'block' : 'none';
            document.getElementById('previewBluesky').style.display = document.getElementById('platform-bluesky').checked ? 'block' : 'none';
            document.getElementById('previewYoutube').style.display = document.getElementById('platform-youtube').checked ? 'block' : 'none';
        }

        // Update previews
        function updatePreviews() {
            const content = document.getElementById('postContent').value;
            const escapedContent = escapeHtml(content);

            document.getElementById('previewXText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';
            document.getElementById('previewBlueskyText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';
            document.getElementById('previewYoutubeText').innerHTML = escapedContent || '<span class="text-gray-500">Your post will appear here...</span>';

            // Image previews
            if (currentImage) {
                document.getElementById('previewXImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewXImage').classList.remove('hidden');
                document.getElementById('previewBlueskyImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewBlueskyImage').classList.remove('hidden');
                document.getElementById('previewYoutubeImage').innerHTML = `<img src="${currentImage}" class="preview-image" alt="Post image">`;
                document.getElementById('previewYoutubeImage').classList.remove('hidden');
            } else {
                document.getElementById('previewXImage').classList.add('hidden');
                document.getElementById('previewBlueskyImage').classList.add('hidden');
                document.getElementById('previewYoutubeImage').classList.add('hidden');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Insert formatting tags
        function insertTag(tag) {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.substring(start, end);

            let replacement = '';
            switch(tag) {
                case 'bold':
                    replacement = `**${selected || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selected || 'italic text'}*`;
                    break;
                case 'link':
                    replacement = `[${selected || 'link text'}](url)`;
                    break;
            }

            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + replacement.length;
            updateCharCounts();
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    document.getElementById('previewImg').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    updatePreviews();
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove image
        function removeImage() {
            currentImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            updatePreviews();
        }

        // Publish post
        async function publishPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                showToast('Please enter some content', 'error');
                return;
            }

            pendingApiPayload = null;
            pendingApiPlatforms = [];
            apiPostingInProgress = false;

            const platforms = [];
            if (document.getElementById('platform-x').checked) platforms.push('x');
            if (document.getElementById('platform-bluesky').checked) platforms.push('bluesky');
            if (document.getElementById('platform-youtube').checked) platforms.push('youtube');

            if (platforms.length === 0) {
                showToast('Please select at least one platform', 'error');
                return;
            }

            const { map: platformContents, overLimit } = buildPlatformContentMap(content, platforms);
            overLimit.forEach(({ platform, limit }) => {
                const label = getPlatformLabel(platform);
                showToast(`${label} limit is ${limit} chars. Posting first ${limit}.`, 'warning');
            });

            const supportedPlatforms = platforms.filter(platform => API_CAPABILITIES[platform]?.enabled);
            const manualPlatforms = platforms.filter(platform => !API_CAPABILITIES[platform]?.enabled);
            const orderedPlatforms = [...manualPlatforms, ...supportedPlatforms];

            // Disable button
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';

            // Handle API platforms (Bluesky) after manual queue completes
            if (supportedPlatforms.length > 0 && pyBridge && pyBridge.handlePublishRequest) {
                pendingApiPayload = {
                    content: content,
                    platforms: supportedPlatforms,
                    image: currentImage,
                    credentials: apiSettings,
                    content_by_platform: platformContents
                };
                pendingApiPlatforms = supportedPlatforms.slice();
            }

            // Initialize queue for all platforms
            initializeQueue(orderedPlatforms, platformContents, currentImage, content);

            // Add to history
            const postRecord = {
                id: Date.now(),
                content,
                image: currentImage,
                platforms: orderedPlatforms,
                results: platforms.map(platform => ({
                    platform,
                    success: API_CAPABILITIES[platform]?.enabled && !!pyBridge,
                    manual: API_CAPABILITIES[platform] ? !API_CAPABILITIES[platform]?.enabled : false,
                    id: Date.now() + Math.random(),
                    skipped: !API_CAPABILITIES[platform]
                })),
                timestamp: new Date().toISOString()
            };

            postHistory.unshift(postRecord);
            if (postHistory.length > 50) postHistory.pop();
            localStorage.setItem('unifiedPublisherHistory', JSON.stringify(postHistory));

            // Show post confirmation modal
            showPostConfirmation(postRecord);

            // Reset UI
            document.getElementById('postContent').value = '';
            removeImage();
            renderHistory();
            updateStats();

            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Publish Transmission</span>';
        }

        // Show post confirmation modal
        function showPostConfirmation(postRecord) {
            // Populate content
            document.getElementById('confirmPostContent').textContent = postRecord.content;

            // Show image if present
            const confirmImageEl = document.getElementById('confirmPostImage');
            if (postRecord.image) {
                confirmImageEl.innerHTML = `<img src="${postRecord.image}" class="max-h-48 rounded-lg" alt="Post image">`;
                confirmImageEl.classList.remove('hidden');
            } else {
                confirmImageEl.classList.add('hidden');
            }

            // Show platform results
            const resultsContainer = document.getElementById('confirmPlatformResults');
            resultsContainer.innerHTML = postRecord.results.map(r => {
                let statusHtml = '';
                let statusClass = '';

                if (r.manual) {
                    statusClass = 'bg-yellow-900/30 border-yellow-700/50';
                    statusHtml = '<i class="fas fa-hand-paper text-yellow-400 mr-2"></i>Manual post opened';
                } else if (r.skipped) {
                    statusClass = 'bg-gray-700/50 border-gray-600';
                    statusHtml = '<i class="fas fa-minus-circle text-gray-400 mr-2"></i>Skipped (unsupported platform)';
                } else if (r.success) {
                    statusClass = 'bg-green-900/30 border-green-700/50';
                    statusHtml = '<i class="fas fa-check-circle text-green-400 mr-2"></i>Published successfully';
                } else {
                    statusClass = 'bg-red-900/30 border-red-700/50';
                    statusHtml = '<i class="fas fa-exclamation-circle text-red-400 mr-2"></i>Failed';
                }

                const platformName = API_CAPABILITIES[r.platform]?.label || r.platform.toUpperCase();

                return `
                    <div class="${statusClass} rounded-lg p-3 border flex items-center justify-between">
                        <span class="text-white font-medium">${platformName}</span>
                        <span class="text-sm text-gray-300">${statusHtml}</span>
                    </div>
                `;
            }).join('');

            // Update stats
            const successfulPlatforms = postRecord.results.filter(r => r.success || r.manual).length;
            document.getElementById('confirmPlatforms').textContent = successfulPlatforms;

            // Format timestamp
            const postTime = new Date(postRecord.timestamp);
            document.getElementById('confirmTimestamp').textContent = postTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // Show modal
            document.getElementById('postConfirmModal').classList.remove('hidden');
        }

        // Close post confirmation modal
        function closePostConfirmation() {
            document.getElementById('postConfirmModal').classList.add('hidden');
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('postConfirmModal');
            if (e.target === modal) {
                closePostConfirmation();
            }
        });

        // Render history
        function renderHistory() {
            const container = document.getElementById('historyContainer');

            if (postHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">No posts yet</p>
                    </div>
                `;
                return;
            }

            const recent = postHistory.slice(0, 5);

            container.innerHTML = recent.map(post => {
                const date = new Date(post.timestamp);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const platformIcons = post.platforms.map(p => {
                    switch(p) {
                        case 'x': return '<i class="fab fa-x-twitter text-gray-400"></i>';
                        case 'bluesky': return '<i class="fas fa-cloud text-blue-400"></i>';
                        case 'youtube': return '<i class="fab fa-youtube text-red-500"></i>';
                        default: return '';
                    }
                }).join(' ');

                const results = post.results.map(r => {
                    if (r.manual) {
                        return '<i class="fas fa-hand-paper text-yellow-400"></i>';
                    }
                    if (r.skipped) {
                        return '<i class="fas fa-minus-circle text-gray-400"></i>';
                    }
                    return r.success
                        ? '<i class="fas fa-check-circle text-green-400"></i>'
                        : '<i class="fas fa-exclamation-circle text-red-400"></i>';
                }).join(' ');

                return `
                    <div class="history-item p-3 bg-gray-800/50 rounded-lg cursor-pointer" onclick="viewPost(${post.id})">
                        <div class="flex items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm truncate">${escapeHtml(post.content.substring(0, 50))}${post.content.length > 50 ? '...' : ''}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-gray-500">${timeStr}</span>
                                    <span class="text-xs text-gray-600">&middot;</span>
                                    <span class="text-xs text-gray-500">${platformIcons}</span>
                                    <span class="text-xs text-gray-600">&middot;</span>
                                    <span>${results}</span>
                                </div>
                            </div>
                            ${post.image ? '<i class="fas fa-image text-gray-500 text-xs"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View post details
        function viewPost(id) {
            const post = postHistory.find(p => p.id === id);
            if (!post) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-2xl w-full max-w-md border border-white/10">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h3 class="font-semibold text-white">Post Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="text-sm text-gray-400">${new Date(post.timestamp).toLocaleString()}</div>
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <p class="text-white whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                            ${post.image ? `<img src="${post.image}" class="mt-3 rounded-lg max-h-48" alt="Post image">` : ''}
                        </div>
                        <div>
                            <div class="text-sm text-gray-400 mb-2">Platforms & Status:</div>
                            <div class="flex flex-wrap gap-2">
                                ${post.results.map(r => `
                                    <span class="px-3 py-1 rounded-full text-sm ${r.manual ? 'bg-yellow-500/20 text-yellow-300' : r.skipped ? 'bg-gray-500/20 text-gray-300' : r.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                        ${r.platform.toUpperCase()} - ${r.manual ? 'Manual' : r.skipped ? 'Skipped' : r.success ? 'Success' : 'Failed'}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Clear history
        function clearHistory() {
            if (confirm('Clear all post history?')) {
                postHistory = [];
                localStorage.setItem('unifiedPublisherHistory', JSON.stringify(postHistory));
                renderHistory();
                updateStats();
            }
        }

        // Update stats
        function updateStats() {
            const today = new Date().toDateString();
            const todayPosts = postHistory.filter(p => new Date(p.timestamp).toDateString() === today);
            const platformsReached = new Set(postHistory.flatMap(p => p.platforms)).size;

            document.getElementById('postsToday').textContent = todayPosts.length;
            document.getElementById('reactionsToday').textContent = '-';
            document.getElementById('platformsReached').textContent = platformsReached;
            document.getElementById('timeSaved').textContent = todayPosts.length > 0 ? `~${todayPosts.length * 2}m` : '-';
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: 'fa-check',
                error: 'fa-times',
                warning: 'fa-exclamation',
                info: 'fa-info'
            };

            toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg flex items-center gap-2 shadow-lg`;
            toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Queue System Functions
        function initializeQueue(platforms, contentByPlatform, image, originalContent) {
            const originalLength = typeof originalContent === 'string' ? originalContent.length : 0;
            queueContentByPlatform = contentByPlatform || {};
            publishQueue = platforms.map(platform => {
                const limit = getPlatformLimit(platform);
                const platformContent = queueContentByPlatform[platform] || '';
                const wasTrimmed = limit ? originalLength > limit : false;
                return {
                    platform,
                    status: 'pending', // 'pending', 'active', 'completed'
                    label: getPlatformLabel(platform),
                    icon: getPlatformIcon(platform),
                    color: getPlatformColor(platform),
                    isApi: API_CAPABILITIES[platform]?.enabled,
                    content: platformContent,
                    limit,
                    wasTrimmed,
                    apiSuccess: null
                };
            });
            currentQueueIndex = -1;
            queueStarted = false;
            queueImage = image;
            apiPostingInProgress = false;
            renderQueue();
            showQueuePanel();

            // Auto-start the queue
            setTimeout(() => startQueue(), 300);
        }

        function getPlatformLabel(platform) {
            const labels = { x: 'X / Twitter', bluesky: 'Bluesky', youtube: 'YouTube' };
            return labels[platform] || platform;
        }

        function getPlatformIcon(platform) {
            const icons = {
                x: 'fab fa-x-twitter',
                bluesky: 'fas fa-cloud',
                youtube: 'fab fa-youtube'
            };
            return icons[platform] || 'fas fa-globe';
        }

        function getPlatformColor(platform) {
            const colors = {
                x: 'gray',
                bluesky: 'blue',
                youtube: 'red'
            };
            return colors[platform] || 'gray';
        }

        function showQueuePanel() {
            document.getElementById('queuePanel').classList.remove('hidden');
        }

        function hideQueuePanel() {
            document.getElementById('queuePanel').classList.add('hidden');
        }

        function renderQueue() {
            const container = document.getElementById('queueItems');
            const completedCount = publishQueue.filter(item => item.status === 'completed').length;
            const totalCount = publishQueue.length;
            const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

            // Update progress bar
            document.getElementById('queueProgressBar').style.width = progressPercent + '%';
            document.getElementById('queueCount').textContent = `${completedCount}/${totalCount}`;

            console.log('[Queue] Rendering queue:', publishQueue.map(i => `${i.platform}:${i.status}`).join(', '));

            // Render queue items
            container.innerHTML = publishQueue.map((item, index) => {
                let statusIcon = '';
                let statusText = '';
                let itemClass = 'queue-item';

                if (item.status === 'completed') {
                    statusIcon = '<i class="checkmark fas fa-check-circle text-green-400 text-xl"></i>';
                    statusText = item.isApi ? 'Posted' : 'Done';
                    itemClass += ' completed';
                } else if (item.status === 'active') {
                    statusIcon = '<i class="fas fa-arrow-right text-blue-400 text-xl"></i>';
                    statusText = item.isApi ? 'Posting' : 'Ready';
                    itemClass += ' active';
                } else {
                    statusIcon = '<i class="fas fa-clock text-gray-600 text-xl"></i>';
                    statusText = 'Waiting';
                }

                const trimNote = item.wasTrimmed && item.limit ? ` â€¢ Trimmed to ${item.limit}` : '';
                return `
                    <div class="${itemClass} bg-gray-800/50 rounded-xl p-4 border border-${item.color}-700/30">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-${item.color}-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="${item.icon} text-white"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-medium">${item.label}</div>
                                <div class="text-xs text-gray-400">
                                    ${statusText} â€¢ ${item.isApi ? 'API' : 'Manual'}${trimNote}
                                </div>
                            </div>
                            ${statusIcon}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleQueueAction() {
            console.log('[Queue] handleQueueAction called, currentQueueIndex:', currentQueueIndex);
            if (apiPostingInProgress) {
                console.log('[Queue] API posting in progress; ignoring manual action');
                return;
            }
            if (currentQueueIndex === -1) {
                // Start the queue
                console.log('[Queue] Starting queue from button click');
                startQueue();
            } else {
                // Process current platform
                console.log('[Queue] Processing current platform from button click');
                processCurrentPlatform();
            }
        }

        function startQueue() {
            if (queueStarted) {
                console.log('[Queue] startQueue called but queue already started');
                return;
            }
            queueStarted = true;
            console.log('[Queue] Starting queue with', publishQueue.length, 'platforms');

            // Find first manual platform
            currentQueueIndex = publishQueue.findIndex(item => !item.isApi);
            console.log('[Queue] First manual platform index:', currentQueueIndex);

            if (currentQueueIndex === -1) {
                console.log('[Queue] No manual platforms; starting API posts');
                startApiPosting();
            } else {
                publishQueue[currentQueueIndex].status = 'active';
                console.log('[Queue] Activated platform:', publishQueue[currentQueueIndex].platform);

                // Force button state BEFORE rendering
                document.getElementById('queueActionBtn').classList.remove('hidden');
                document.getElementById('queueDoneBtn').classList.add('hidden');
                document.getElementById('queueActionText').textContent = `Open ${publishQueue[currentQueueIndex].label}`;

                renderQueue();
                processCurrentPlatform();
            }
        }

        function processCurrentPlatform() {
            if (currentQueueIndex < 0 || currentQueueIndex >= publishQueue.length) {
                console.log('[Queue] Invalid queue index:', currentQueueIndex);
                return;
            }

            const current = publishQueue[currentQueueIndex];
            console.log('[Queue] Processing platform:', current.platform);
            const platformContent = current.content || '';

            if (current.platform === 'youtube') {
                // Copy text to clipboard for YouTube
                copyTextToClipboard(platformContent);
                showToast('âœ“ Text copied - paste in YouTube Studio', 'success');
            } else if (current.platform === 'x') {
                // Also copy to clipboard as backup for X
                copyTextToClipboard(platformContent);
                showToast('âœ“ Opening X composer (text also copied to clipboard)', 'success');
            } else if (current.wasTrimmed) {
                copyTextToClipboard(platformContent);
                showToast(`âœ“ Trimmed text copied for ${current.label}`, 'success');
            }

            // Open composer
            console.log('[Queue] Opening composer for:', current.platform, 'with content:', platformContent);
            openComposer(current.platform, platformContent);

            // Show "Done" button
            document.getElementById('queueActionBtn').classList.add('hidden');
            document.getElementById('queueDoneBtn').classList.remove('hidden');
        }

        function markCurrentDone() {
            if (currentQueueIndex < 0 || currentQueueIndex >= publishQueue.length) {
                console.log('[Queue] markCurrentDone called with invalid index:', currentQueueIndex);
                return;
            }

            const current = publishQueue[currentQueueIndex];
            console.log('[Queue] Marking platform as done:', current.platform);

            // Mark current as completed
            publishQueue[currentQueueIndex].status = 'completed';

            // Move to next platform
            currentQueueIndex++;
            console.log('[Queue] Moving to next index:', currentQueueIndex);

            // Find next non-completed platform
            while (currentQueueIndex < publishQueue.length && publishQueue[currentQueueIndex].status === 'completed') {
                console.log('[Queue] Skipping already completed platform at index:', currentQueueIndex);
                currentQueueIndex++;
            }

            if (currentQueueIndex >= publishQueue.length) {
                // All done!
                console.log('[Queue] All platforms processed, completing queue');
                completeQueue();
            } else {
                if (publishQueue[currentQueueIndex].isApi) {
                    console.log('[Queue] Manual done, starting API posts');
                    startApiPosting();
                } else {
                    // Activate next platform
                    console.log('[Queue] Activating next platform:', publishQueue[currentQueueIndex].platform);
                    publishQueue[currentQueueIndex].status = 'active';

                    // Force button state for next platform
                    document.getElementById('queueActionBtn').classList.remove('hidden');
                    document.getElementById('queueDoneBtn').classList.add('hidden');
                    document.getElementById('queueActionText').textContent = `Open ${publishQueue[currentQueueIndex].label}`;

                    renderQueue();
                }
            }
        }

        // Called from Python when composer detects successful post
        function handleComposerPostSuccess(platform) {
            console.log('[Queue] Post success signal received for:', platform);

            // Find the platform in queue and mark as completed
            const platformIndex = publishQueue.findIndex(item => item.platform === platform);
            if (platformIndex === -1) {
                console.warn('[Queue] Platform not found in queue:', platform);
                return;
            }

            // Mark as completed
            publishQueue[platformIndex].status = 'completed';
            console.log('[Queue] Marked', platform, 'as completed');

            // Find next incomplete manual platform
            const nextManualIndex = publishQueue.findIndex(item =>
                !item.isApi && item.status !== 'completed'
            );

            if (nextManualIndex !== -1) {
                // Auto-advance to next manual platform
                console.log('[Queue] Auto-advancing to next platform:', publishQueue[nextManualIndex].platform);
                currentQueueIndex = nextManualIndex;
                publishQueue[nextManualIndex].status = 'active';

                // Update button state
                document.getElementById('queueActionBtn').classList.add('hidden');
                document.getElementById('queueDoneBtn').classList.add('hidden');

                renderQueue();

                // Auto-open next composer after brief delay
                setTimeout(() => {
                    processCurrentPlatform();
                }, 500);
            } else {
                // All manual platforms done, start API posting
                console.log('[Queue] All manual platforms done, starting API posts');
                renderQueue();
                startApiPosting();
            }
        }

        function startApiPosting() {
            if (apiPostingInProgress) {
                console.log('[Queue] API posting already in progress');
                return;
            }

            if (!pendingApiPayload || pendingApiPlatforms.length === 0) {
                console.log('[Queue] No pending API payload; completing queue');
                completeQueue();
                return;
            }

            apiPostingInProgress = true;
            publishQueue.forEach(item => {
                if (item.isApi && item.status !== 'completed') {
                    item.status = 'active';
                }
            });

            // Hide manual action buttons while API posts
            document.getElementById('queueActionBtn').classList.add('hidden');
            document.getElementById('queueDoneBtn').classList.add('hidden');

            renderQueue();
            if (pyBridge && pyBridge.handlePublishRequest) {
                pyBridge.handlePublishRequest(JSON.stringify(pendingApiPayload));
            } else {
                console.warn('[Queue] API bridge unavailable, marking API items complete');
                publishQueue.forEach(item => {
                    if (item.isApi && item.status !== 'completed') {
                        item.status = 'completed';
                    }
                });
                apiPostingInProgress = false;
                completeQueue();
            }
        }

        function markApiPlatformResult(platform, success) {
            const item = publishQueue.find(queueItem => queueItem.platform === platform);
            if (!item) return;

            item.status = 'completed';
            item.apiSuccess = success;
            renderQueue();

            const remaining = publishQueue.filter(queueItem => queueItem.isApi && queueItem.status !== 'completed');
            if (apiPostingInProgress && remaining.length === 0) {
                apiPostingInProgress = false;
                completeQueue();
            }
        }

        function handlePlatformAutoComplete(platform, success) {
            const item = publishQueue.find(queueItem => queueItem.platform === platform);
            if (!item) return;

            if (item.isApi) {
                markApiPlatformResult(platform, success);
                return;
            }

            if (item.status === 'active' && publishQueue[currentQueueIndex]?.platform === platform) {
                markCurrentDone();
            } else if (item.status !== 'completed') {
                item.status = 'completed';
                renderQueue();
            }
        }

        function completeQueue() {
            console.log('[Queue] Queue complete! Final statuses:', publishQueue.map(i => `${i.platform}:${i.status}`).join(', '));
            renderQueue();
            document.getElementById('queueActions').classList.add('hidden');
            document.getElementById('queueComplete').classList.remove('hidden');
            document.getElementById('queuePanel').classList.add('celebrate');

            setTimeout(() => {
                document.getElementById('queuePanel').classList.remove('celebrate');
            }, 600);

            // Auto-hide after 10 seconds (increased from 5)
            setTimeout(() => {
                console.log('[Queue] Auto-hiding queue panel');
                resetQueue();
            }, 10000);
        }

        function resetQueue() {
            publishQueue = [];
            currentQueueIndex = -1;
            queueContentByPlatform = {};
            queueImage = null;
            queueStarted = false;
            pendingApiPayload = null;
            pendingApiPlatforms = [];
            apiPostingInProgress = false;
            hideQueuePanel();
            document.getElementById('queueActions').classList.remove('hidden');
            document.getElementById('queueComplete').classList.add('hidden');
            document.getElementById('queueActionBtn').classList.remove('hidden');
            document.getElementById('queueDoneBtn').classList.add('hidden');
        }

        function updateQueueButtons() {
            const current = publishQueue[currentQueueIndex];
            if (!current) return;

            const actionBtn = document.getElementById('queueActionBtn');
            const actionText = document.getElementById('queueActionText');

            actionBtn.classList.remove('hidden');
            document.getElementById('queueDoneBtn').classList.add('hidden');

            actionText.textContent = `Open ${current.label}`;
        }

        async function copyTextToClipboard(text) {
            if (pyBridge && pyBridge.setClipboardText) {
                try {
                    const ok = await pyBridge.setClipboardText(text);
                    if (ok) return;
                } catch (error) {
                    console.warn('[Clipboard] Bridge copy failed:', error);
                }
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => {
                    fallbackCopyContent(text);
                });
            } else {
                fallbackCopyContent(text);
            }
        }

        async function copyPostContent() {
            const content = document.getElementById('postContent').value;
            if (!content) {
                showToast('Nothing to copy yet', 'warning');
                return;
            }
            await copyTextToClipboard(content);
            showToast('Copied to clipboard', 'success');
        }

        function fallbackCopyContent(content) {
            const textarea = document.getElementById('postContent');
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard', 'success');
            } catch (err) {
                showToast('Copy failed. Please select and copy manually.', 'error');
            }
        }

        function normalizeYoutubeHandle(handle) {
            if (!handle) return '';
            let cleaned = handle.trim();
            if (!cleaned) return '';

            const urlMatch = cleaned.match(/youtube\.com\/@([^/?#]+)/i);
            if (urlMatch) return urlMatch[1];

            const atMatch = cleaned.match(/@([^/?#]+)/);
            if (atMatch) return atMatch[1];

            cleaned = cleaned.replace(/^@+/, '');
            cleaned = cleaned.replace(/^https?:\/\/(www\.)?youtube\.com\//i, '');
            cleaned = cleaned.replace(/^(channel\/|c\/|user\/)/i, '');
            cleaned = cleaned.split(/[/?#]/)[0];
            return cleaned;
        }

        function isYoutubeChannelId(value) {
            if (!value) return false;
            return /^UC[a-zA-Z0-9_-]{20,}$/.test(value);
        }

        function openComposer(platform, contentOverride = null) {
            console.log('[Composer] Opening composer for platform:', platform);
            const content = document.getElementById('postContent').value;
            const baseContent = contentOverride !== null ? contentOverride : content;
            const textToUse = getPlatformContent(platform, baseContent);
            console.log('[Composer] Content to use:', textToUse);

            let url = '';
            if (platform === 'x') {
                // Try intent URL first - we clear corrupted storage before opening
                if (textToUse) {
                    const encoded = encodeURIComponent(textToUse);
                    url = `https://x.com/intent/post?text=${encoded}`;
                } else {
                    url = 'https://x.com/compose/post';
                }
            } else if (platform === 'youtube') {
                console.log('[Composer] YouTube apiSettings:', JSON.stringify(apiSettings.youtube));
                const rawChannelId = apiSettings.youtube?.channelId || '';
                const channelHandle = normalizeYoutubeHandle(rawChannelId);
                console.log('[Composer] YouTube channelId raw:', rawChannelId, 'normalized:', channelHandle);
                if (channelHandle) {
                    url = isYoutubeChannelId(channelHandle)
                        ? `https://www.youtube.com/channel/${channelHandle}/community`
                        : `https://www.youtube.com/@${channelHandle}/community`;
                } else {
                    console.warn('[Composer] âš  No YouTube channelId set! Opening base YouTube URL. Login to YouTube first to set your channel.');
                    url = 'https://www.youtube.com/';
                }
            }

            console.log('[Composer] Generated URL:', url);
            if (!url) {
                console.log('[Composer] No URL generated, aborting');
                return;
            }

            console.log('[Composer] pyBridge available:', !!pyBridge);

            // X and YouTube use external browser (cookies don't persist in embedded view)
            if ((platform === 'x' || platform === 'youtube') && pyBridge && pyBridge.openExternalUrl) {
                console.log('[Composer] Opening in external browser (X/YT use system browser)');
                pyBridge.openExternalUrl(url);
            } else if (pyBridge && pyBridge.openInternalUrl) {
                pyBridge.openInternalUrl(url);
            } else if (pyBridge && pyBridge.openExternalUrl) {
                console.log('[Composer] Opening in external browser');
                pyBridge.openExternalUrl(url);
            } else {
                console.log('[Composer] Fallback: opening in new window');
                window.open(url, '_blank', 'noopener');
            }
        }

        function openLogin(platform) {
            let url = '';
            if (platform === 'x') {
                url = 'https://x.com/login';
            } else if (platform === 'youtube') {
                url = 'https://www.youtube.com/';
            }

            if (!url) return;

            if (pyBridge && pyBridge.openInternalUrl) {
                pyBridge.openInternalUrl(url);
            } else if (pyBridge && pyBridge.openExternalUrl) {
                pyBridge.openExternalUrl(url);
            } else {
                window.open(url, '_blank', 'noopener');
            }
        }

        // Settings modal
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');

            // Refresh login status indicators when modal opens
            if (apiSettings.x?.handle) {
                updateLoginIndicator('x', true, apiSettings.x.handle);
            } else {
                updateLoginIndicator('x', false, '');
            }
            if (apiSettings.youtube?.channelId) {
                updateLoginIndicator('youtube', true, apiSettings.youtube.channelId);
            } else {
                updateLoginIndicator('youtube', false, '');
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openApiKeys() {
            openSettings();
        }

        // Save API settings
        async function saveApiSettings() {
            // Preserve existing avatar data when saving
            const existingBlueskyAvatar = apiSettings.bluesky?.avatar;
            const existingXAvatar = apiSettings.x?.avatar;
            const existingYoutubeAvatar = apiSettings.youtube?.avatar;
            const youtubeHandle = normalizeYoutubeHandle(document.getElementById('ytChannelId').value);
            const xLimitModeEl = document.getElementById('xCharLimitMode');
            const xLimitCustomEl = document.getElementById('xCharLimitCustom');
            const xLimitMode = xLimitModeEl ? xLimitModeEl.value : (apiSettings.x?.limitMode || 'standard');
            const xCustomLimitRaw = xLimitCustomEl ? xLimitCustomEl.value : '';
            const xCustomLimit = Number.parseInt(xCustomLimitRaw, 10);
            const xCustomLimitValue = Number.isFinite(xCustomLimit) && xCustomLimit > 0 ? xCustomLimit : null;
            const rendererModeEl = document.getElementById('rendererMode');
            const rendererMode = rendererModeEl ? rendererModeEl.value : (apiSettings.preferences?.rendererMode || 'auto');
            const previousRendererMode = apiSettings.preferences?.rendererMode || 'auto';

            // Get checkbox values if elements exist
            const internalCheckbox = document.getElementById('openComposersInternal');
            const externalYoutubeCheckbox = document.getElementById('forceExternalYoutube');

            apiSettings = {
                bluesky: {
                    handle: document.getElementById('bskyHandle').value,
                    password: document.getElementById('bskyPassword').value,
                    avatar: existingBlueskyAvatar
                },
                youtube: {
                    channelId: youtubeHandle,
                    avatar: existingYoutubeAvatar
                },
                x: {
                    handle: apiSettings.x?.handle,
                    avatar: existingXAvatar,
                    limitMode: xLimitMode,
                    customLimit: xLimitMode === 'custom' ? xCustomLimitValue : null
                },
                preferences: {
                    openComposersInternal: internalCheckbox ? internalCheckbox.checked : true,
                    forceExternalYoutube: externalYoutubeCheckbox ? externalYoutubeCheckbox.checked : false,
                    rendererMode: rendererMode
                }
            };

            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            updatePreviewIdentity();
            refreshXLimitUI();
            updateCharCounts();

            // Show success feedback
            showToast('âœ“ Settings saved successfully!', 'success');
            if (rendererMode !== previousRendererMode) {
                showToast('Renderer mode updated. Restart app to apply.', 'info');
            }

            if (pyBridge && pyBridge.saveRendererMode) {
                try {
                    await pyBridge.saveRendererMode(rendererMode);
                } catch (error) {
                    console.error('[Renderer] Failed to save renderer mode:', error);
                }
            }

            // Close modal after a short delay so user sees the toast
            setTimeout(() => {
                closeSettings();
            }, 500);
        }

        function handleXCharLimitModeChange() {
            const modeEl = document.getElementById('xCharLimitMode');
            const customEl = document.getElementById('xCharLimitCustom');
            if (!modeEl || !customEl) return;

            if (modeEl.value === 'custom') {
                customEl.classList.remove('hidden');
            } else {
                customEl.classList.add('hidden');
            }
            updateCharCounts();
        }

        // Load encrypted credentials on startup
        async function loadEncryptedCredentials() {
            try {
                if (pyBridge && pyBridge.hasSavedCredentials) {
                    const hasCreds = await pyBridge.hasSavedCredentials();
                    if (hasCreds && pyBridge.loadSavedCredentials) {
                        const credsJson = await pyBridge.loadSavedCredentials();
                        if (credsJson) {
                            const creds = JSON.parse(credsJson);
                            console.log('[Credentials] âœ“ Loaded encrypted credentials for:', creds.handle);

                            // Populate settings
                            if (!apiSettings.bluesky) {
                                apiSettings.bluesky = {};
                            }
                            apiSettings.bluesky.handle = creds.handle;
                            apiSettings.bluesky.password = creds.password;

                            // Save to localStorage for session
                            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                            // Update UI
                            document.getElementById('bskyHandle').value = creds.handle;
                            document.getElementById('bskyPassword').value = creds.password;
                            updateBlueskyLoginStatus(creds.handle, '');

                            showToast('ðŸ” Bluesky credentials loaded from secure storage', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('[Credentials] Failed to load encrypted credentials:', error);
            }
        }

        // Load API settings
        function loadApiSettings() {
            if (apiSettings.bluesky?.handle) document.getElementById('bskyHandle').value = apiSettings.bluesky.handle;
            if (apiSettings.bluesky?.password) document.getElementById('bskyPassword').value = apiSettings.bluesky.password;
            if (apiSettings.youtube?.channelId) document.getElementById('ytChannelId').value = apiSettings.youtube.channelId;
            const xLimitModeEl = document.getElementById('xCharLimitMode');
            const xLimitCustomEl = document.getElementById('xCharLimitCustom');
            if (xLimitModeEl) xLimitModeEl.value = apiSettings.x?.limitMode || 'standard';
            if (xLimitCustomEl) xLimitCustomEl.value = apiSettings.x?.customLimit || '';
            handleXCharLimitModeChange();
            refreshXLimitUI();
            const rendererModeEl = document.getElementById('rendererMode');
            if (rendererModeEl) rendererModeEl.value = apiSettings.preferences?.rendererMode || 'auto';

            // Load checkbox preferences only if elements exist (removed from UI)
            const internalCheckbox = document.getElementById('openComposersInternal');
            const externalYoutubeCheckbox = document.getElementById('forceExternalYoutube');
            if (internalCheckbox) {
                const internalPreference = apiSettings.preferences?.openComposersInternal;
                internalCheckbox.checked = internalPreference !== false;
            }
            if (externalYoutubeCheckbox) {
                const forceExternalPreference = apiSettings.preferences?.forceExternalYoutube;
                externalYoutubeCheckbox.checked = forceExternalPreference !== false;
            }

            updatePreviewIdentity();

            // Load encrypted credentials after localStorage settings
            loadEncryptedCredentials();
        }

        async function syncRendererModeFromBridge() {
            if (!pyBridge || !pyBridge.loadRendererMode) return;
            try {
                const backendMode = await pyBridge.loadRendererMode();
                if (!backendMode) return;
                const currentMode = apiSettings.preferences?.rendererMode;
                if (!currentMode || currentMode === 'auto') {
                    apiSettings.preferences = apiSettings.preferences || {};
                    apiSettings.preferences.rendererMode = backendMode;
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
                    const rendererModeEl = document.getElementById('rendererMode');
                    if (rendererModeEl) rendererModeEl.value = backendMode;
                }
            } catch (error) {
                console.error('[Renderer] Failed to load renderer mode:', error);
            }
        }

        async function loadPlatformProfilesFromBridge() {
            if (!pyBridge || !pyBridge.loadPlatformProfiles) return;
            try {
                const profilesJson = await pyBridge.loadPlatformProfiles();
                if (!profilesJson) return;
                const profiles = JSON.parse(profilesJson);
                let updated = false;

                if (profiles.x && !apiSettings.x?.handle) {
                    apiSettings.x = { ...(apiSettings.x || {}), ...profiles.x };
                    updated = true;
                }

                if (profiles.youtube && !apiSettings.youtube?.channelId) {
                    apiSettings.youtube = { ...(apiSettings.youtube || {}), ...profiles.youtube };
                    updated = true;
                }

                if (updated) {
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
                    const handleInput = document.getElementById('xHandle');
                    if (handleInput && apiSettings.x?.handle) handleInput.value = apiSettings.x.handle;
                    const channelInput = document.getElementById('ytChannelId');
                    if (channelInput && apiSettings.youtube?.channelId) channelInput.value = apiSettings.youtube.channelId;
                    updatePreviewIdentity();
                    if (apiSettings.x?.handle) updateLoginIndicator('x', true, apiSettings.x.handle);
                    if (apiSettings.youtube?.channelId) updateLoginIndicator('youtube', true, apiSettings.youtube.channelId);
                    refreshXLimitUI();
                    handleXCharLimitModeChange();
                    updateCharCounts();
                }
            } catch (error) {
                console.error('[Profiles] Failed to load platform profiles:', error);
            }
        }

        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });

        // Initialize stats
        updateStats();

        function updatePreviewIdentity() {
            // Update X preview
            const xHandle = (apiSettings.x?.handle || '').trim();
            if (xHandle) {
                const cleanX = xHandle.startsWith('@') ? xHandle.slice(1) : xHandle;
                document.getElementById('previewXName').textContent = cleanX || 'Your Name';
                document.getElementById('previewXHandle').textContent = `@${cleanX}`;

                if (apiSettings.x?.avatar) {
                    const avatarImg = document.getElementById('previewXAvatar');
                    const placeholder = document.getElementById('previewXAvatarPlaceholder');
                    avatarImg.src = apiSettings.x.avatar;
                    avatarImg.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            } else {
                document.getElementById('previewXName').textContent = 'Your Name';
                document.getElementById('previewXHandle').textContent = '@handle';
            }

            // Update Bluesky preview
            const bskyHandle = (apiSettings.bluesky?.handle || '').trim();
            if (bskyHandle) {
                const cleanBsky = bskyHandle.startsWith('@') ? bskyHandle.slice(1) : bskyHandle;
                const displayName = cleanBsky.split('.')[0] || cleanBsky;
                document.getElementById('previewBlueskyName').textContent = displayName || 'Bluesky User';
                document.getElementById('previewBlueskyHandle').textContent = `@${cleanBsky}`;

                if (apiSettings.bluesky?.avatar) {
                    const avatarImg = document.getElementById('previewBlueskyAvatar');
                    const placeholder = document.getElementById('previewBlueskyAvatarPlaceholder');
                    avatarImg.src = apiSettings.bluesky.avatar;
                    avatarImg.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            } else {
                document.getElementById('previewBlueskyName').textContent = 'Your Name';
                document.getElementById('previewBlueskyHandle').textContent = '@handle.bsky.social';
            }

            // Update YouTube preview
            const ytChannelId = (apiSettings.youtube?.channelId || '').trim();
            document.getElementById('previewYoutubeName').textContent = ytChannelId ? 'Your Channel' : 'Your Channel';
            document.getElementById('previewYoutubeHandle').textContent = ytChannelId ? `@${ytChannelId}` : 'YouTube';

            if (apiSettings.youtube?.avatar) {
                const avatarImg = document.getElementById('previewYoutubeAvatar');
                const placeholder = document.getElementById('previewYoutubeAvatarPlaceholder');
                avatarImg.src = apiSettings.youtube.avatar;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        }

        function shouldUseInternalComposer(platform) {
            const preferences = apiSettings.preferences || {};
            const internalEnabled = preferences.openComposersInternal !== false;
            const forceExternalYoutube = preferences.forceExternalYoutube === true;

            if (platform === 'youtube' && forceExternalYoutube) {
                return false;
            }
            return internalEnabled;
        }

        // Bluesky helper functions
        function openBlueskyAppPasswordSettings() {
            const url = 'https://bsky.app/settings/app-passwords';
            if (pyBridge && pyBridge.openInternalUrl) {
                pyBridge.openInternalUrl(url);
            } else {
                window.open(url, '_blank', 'noopener');
            }
        }

        async function deleteSavedCredentials() {
            if (!confirm('Are you sure you want to delete your saved encrypted Bluesky credentials?')) {
                return;
            }

            try {
                if (pyBridge && pyBridge.deleteSavedCredentials) {
                    const result = await pyBridge.deleteSavedCredentials();
                    if (result) {
                        if (apiSettings.bluesky) {
                            delete apiSettings.bluesky.password;
                            delete apiSettings.bluesky.handle;
                            delete apiSettings.bluesky.avatar;
                        }
                        localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
                        document.getElementById('bskyHandle').value = '';
                        document.getElementById('bskyPassword').value = '';
                        showToast('âœ“ Encrypted credentials deleted', 'success');
                        updateBlueskyLoginStatus('', '');
                    } else {
                        showToast('Failed to delete credentials', 'error');
                    }
                } else {
                    showToast('Delete function not available', 'error');
                }
            } catch (error) {
                console.error('[Credentials] Delete failed:', error);
                showToast('Error deleting credentials', 'error');
            }
        }

        async function testBlueskyConnection() {
            const handle = document.getElementById('bskyHandle').value.trim();
            const password = document.getElementById('bskyPassword').value.trim();
            const statusEl = document.getElementById('bskyConnectionStatus');

            if (!handle || !password) {
                statusEl.innerHTML = `
                    <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                        <span class="text-xs text-red-300">Please enter both handle and app password</span>
                    </div>
                `;
                statusEl.classList.remove('hidden');
                return;
            }

            // Show loading state
            statusEl.innerHTML = `
                <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-2 flex items-center gap-2">
                    <i class="fas fa-spinner fa-spin text-blue-400"></i>
                    <span class="text-xs text-blue-300">Testing connection...</span>
                </div>
            `;
            statusEl.classList.remove('hidden');

            try {
            // Use the Python bridge to test Bluesky connection
            if (pyBridge && pyBridge.testBlueskyConnection) {
                const result = await pyBridge.testBlueskyConnection(handle, password);
                console.log('[Bluesky] test result:', result);
                if (result && typeof result === 'object') {
                    statusEl.innerHTML = `
                        <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-2 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            <span class="text-xs text-green-300">${result.message || 'âœ“ Connection successful! Credentials saved.'}</span>
                        </div>
                    `;
                    apiSettings.bluesky = { handle, password };
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
                    updateBlueskyLoginStatus(result.handle || handle, result.avatar || '');
                    showToast(`âœ“ Bluesky connected as ${result.handle || handle}`, 'success');
                    document.getElementById('platform-bluesky').checked = true;
                    updateCharCounts();
                } else if (result === true) {

                        statusEl.innerHTML = `
                            <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-2 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span class="text-xs text-green-300">âœ“ Connection successful! Credentials saved.</span>
                            </div>
                        `;
                        // Auto-save on successful test
                        apiSettings.bluesky = { handle, password };
                        localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                        // Update preview with handle (no avatar from app password login)
                        updateBlueskyLoginStatus(handle, '');
                        showToast(`âœ“ Bluesky connected as ${handle}`, 'success');
                        document.getElementById('platform-bluesky').checked = true;
                        updateCharCounts();
                    } else {
                        throw new Error('Authentication failed');
                    }
                } else {
                    // Fallback: just save without testing
                    statusEl.innerHTML = `
                        <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-yellow-400"></i>
                            <span class="text-xs text-yellow-300">Saved (test unavailable in this mode)</span>
                        </div>
                    `;
                    apiSettings.bluesky = { handle, password };
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));

                    // Update preview with handle
                    updateBlueskyLoginStatus(handle, '');
                    showToast(`âœ“ Bluesky credentials saved`, 'success');
                }
            } catch (error) {
                statusEl.innerHTML = `
                    <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-2 flex items-center gap-2">
                        <i class="fas fa-times-circle text-red-400"></i>
                        <span class="text-xs text-red-300">Connection failed. Check your credentials.</span>
                    </div>
                `;
            }

            // Hide status after 8 seconds to avoid flashing success/failure
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 8000);
        }

        // Login status update functions (called from ComposerWindow)
        function updateXLoginStatus(username, avatarUrl, isVerified = false) {
            console.log('[Login] X login detected:', username, 'Avatar:', avatarUrl, 'Verified:', isVerified);

            // Auto-populate settings
            apiSettings.x = apiSettings.x || {};
            apiSettings.x.handle = username;
            if (avatarUrl) apiSettings.x.avatar = avatarUrl;
            apiSettings.x.verified = isVerified;

            // Auto-set character limit mode based on verification status
            // BUT: Only override if user hasn't set a custom limit
            const customLimitValue = Number(apiSettings.x.customLimit);
            const hasCustomLimit = apiSettings.x.limitMode === 'custom' && Number.isFinite(customLimitValue) && customLimitValue > 0;
            if (!hasCustomLimit) {
                if (isVerified) {
                    apiSettings.x.limitMode = 'premium';
                    apiSettings.x.customLimit = null;
                    console.log('[Login] X Premium detected - setting limit to 25000 characters');
                } else {
                    apiSettings.x.limitMode = 'standard';
                    apiSettings.x.customLimit = null;
                    console.log('[Login] Standard X account - setting limit to 280 characters');
                }
            } else {
                console.log('[Login] Custom limit preserved:', apiSettings.x.customLimit);
            }

            // Update UI field
            const handleInput = document.getElementById('xHandle');
            if (handleInput) {
                handleInput.value = username;
            }

            // Update character limit dropdown and display
            const xLimitModeSelect = document.getElementById('xCharLimitMode');
            if (xLimitModeSelect) {
                xLimitModeSelect.value = apiSettings.x.limitMode;
            }
            handleXCharLimitModeChange();
            updateCharCounts();

            // Update preview names and avatar
            document.getElementById('previewXName').textContent = username || 'Your Name';
            document.getElementById('previewXHandle').textContent = `@${username}`;

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewXAvatar');
                const placeholder = document.getElementById('previewXAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Show success indicator with verification badge
            const verificationBadge = isVerified ? ' âœ“' : '';
            updateLoginIndicator('x', true, username + verificationBadge);

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            if (pyBridge && pyBridge.savePlatformProfile) {
                const profilePayload = {
                    handle: apiSettings.x.handle,
                    avatar: apiSettings.x.avatar || '',
                    verified: apiSettings.x.verified || false,
                    limitMode: apiSettings.x.limitMode || 'standard',
                    customLimit: apiSettings.x.customLimit || null
                };
                pyBridge.savePlatformProfile('x', JSON.stringify(profilePayload));
            }
            showToast(`âœ“ Logged in to X as @${username}${isVerified ? ' (Premium)' : ''}`, 'success');
        }

        function updateYouTubeLoginStatus(handle, avatarUrl) {
            console.log('[Login] YouTube login detected:', handle, 'Avatar:', avatarUrl);
            const cleanHandle = normalizeYoutubeHandle(handle);
            const isChannelId = isYoutubeChannelId(cleanHandle);

            // Auto-populate settings
            apiSettings.youtube = apiSettings.youtube || {};
            apiSettings.youtube.channelId = cleanHandle;
            if (avatarUrl) apiSettings.youtube.avatar = avatarUrl;

            // Update UI field
            const channelInput = document.getElementById('ytChannelId');
            if (channelInput) {
                channelInput.value = cleanHandle;
            }

            // Update preview names and avatar
            document.getElementById('previewYoutubeName').textContent = cleanHandle || 'Your Channel';
            document.getElementById('previewYoutubeHandle').textContent = cleanHandle
                ? (isChannelId ? cleanHandle : `@${cleanHandle}`)
                : 'YouTube';

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewYoutubeAvatar');
                const placeholder = document.getElementById('previewYoutubeAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Show success indicator
            updateLoginIndicator('youtube', true, cleanHandle);

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            if (pyBridge && pyBridge.savePlatformProfile) {
                const profilePayload = {
                    channelId: cleanHandle,
                    avatar: apiSettings.youtube.avatar || ''
                };
                pyBridge.savePlatformProfile('youtube', JSON.stringify(profilePayload));
            }
            showToast(`âœ“ Logged in to YouTube as ${isChannelId ? cleanHandle : `@${cleanHandle}`}`, 'success');
        }

        function updateBlueskyLoginStatus(handle, avatarUrl) {
            console.log('[Login] Bluesky login detected:', handle, 'Avatar:', avatarUrl);

            // Auto-populate settings
            apiSettings.bluesky = apiSettings.bluesky || {};
            apiSettings.bluesky.handle = handle;
            if (avatarUrl) apiSettings.bluesky.avatar = avatarUrl;

            // Update UI field
            const handleInput = document.getElementById('bskyHandle');
            if (handleInput) {
                handleInput.value = handle;
            }

            // Update preview names and avatar
            const cleanBsky = handle.startsWith('@') ? handle.slice(1) : handle;
            const displayName = cleanBsky.split('.')[0] || cleanBsky;
            document.getElementById('previewBlueskyName').textContent = displayName || 'Bluesky User';
            document.getElementById('previewBlueskyHandle').textContent = `@${cleanBsky}`;

            if (avatarUrl) {
                const avatarImg = document.getElementById('previewBlueskyAvatar');
                const placeholder = document.getElementById('previewBlueskyAvatarPlaceholder');
                avatarImg.src = avatarUrl;
                avatarImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }

            // Save settings
            localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
            showToast(`âœ“ Logged in to Bluesky as ${cleanBsky}`, 'success');
        }

        function updateLoginIndicator(platform, isLoggedIn, username) {
            // Update login status indicators in the settings modal
            const indicators = {
                x: document.getElementById('xLoginStatus'),
                youtube: document.getElementById('ytLoginStatus')
            };

            const platformNames = {
                x: 'X',
                youtube: 'YouTube'
            };

            const indicator = indicators[platform];
            if (indicator) {
                if (isLoggedIn && username) {
                    indicator.innerHTML = `<span class="text-green-400"><i class="fas fa-check-circle mr-1"></i>Logged in as @${username}</span>`;
                } else {
                    indicator.innerHTML = `<span class="text-gray-400"><i class="fas fa-circle mr-1"></i>${platformNames[platform]}: Not logged in</span>`;
                }
            }
        }

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we have saved credentials/sessions
            if (apiSettings.x?.handle) {
                updateLoginIndicator('x', true, apiSettings.x.handle);
            }
            if (apiSettings.youtube?.channelId) {
                updateLoginIndicator('youtube', true, apiSettings.youtube.channelId);
            }
        });

        // JavaScript Cleanup Function
        function cleanupApplication() {
            console.log('[Cleanup] Starting JavaScript cleanup...');
            
            try {
                // Stop any ongoing API requests or timers
                if (publishQueue.length > 0 || queueStarted) {
                    console.log('[Cleanup] Stopping active queue operations...');
                    queueStarted = false;
                    publishQueue = [];
                    currentQueueIndex = -1;
                }
                
                // Save any unsaved data
                if (postHistory && postHistory.length > 0) {
                    localStorage.setItem('unifiedPublisherHistory', JSON.stringify(postHistory));
                    console.log('[Cleanup] Saved post history');
                }
                
                if (apiSettings && Object.keys(apiSettings).length > 0) {
                    localStorage.setItem('unifiedPublisherApiSettings', JSON.stringify(apiSettings));
                    console.log('[Cleanup] Saved API settings');
                }
                
                // Clear any active toasts or notifications
                const toastContainer = document.getElementById('toastContainer');
                if (toastContainer) {
                    toastContainer.innerHTML = '';
                }
                
                // Reset any active animations or timeouts
                const timeouts = [];
                for (let i = 0; i < timeouts.length; i++) {
                    clearTimeout(timeouts[i]);
                }
                
                console.log('[Cleanup] âœ… JavaScript cleanup completed');
                return true;
            } catch (error) {
                console.error('[Cleanup] âš  Error during JavaScript cleanup:', error);
                return false;
            }
        }

        // Auto-cleanup on page unload
        window.addEventListener('beforeunload', function(event) {
            console.log('[Cleanup] Page unloading, performing cleanup...');
            cleanupApplication();
        });

        // Add cleanup method to bridge so Python can call it
        function performJsCleanup() {
            return cleanupApplication();
        }

        console.log('[Cleanup] JavaScript cleanup functions registered');
    </script>
</body>
</html>
